<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0f1a" id="metaTheme" />
  <title>Gioco Spia ‚Äî Edizione Pro (Fake Spy + Avvocato)</title>
  <meta name="description" content="Party game mobile-first. Ruoli: Spia, Finta Spia, Avvocato, Civile. Timer, voto, categorie personalizzate. PWA + tema auto." />
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
    <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%2367e8f9"/><stop offset="1" stop-color="%2394a3b8"/></linearGradient></defs>
    <rect rx="28" width="128" height="128" fill="url(%23g)"/>
    <g fill="%230d0f1a" transform="translate(24,24)">
      <circle cx="24" cy="24" r="10"/>
      <rect x="18" y="52" width="60" height="10" rx="5"/>
      <path d="M12 72c8 8 20 12 34 12s26-4 34-12l-6-8c-7 7-17 10-28 10s-21-3-28-10z"/>
    </g>
  </svg>' />
  <style>
    /* ====== Reset & Tokens ====== */
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --bg:#0d0f1a; --surface:#111425; --surface-2:#0b1020; --line:rgba(255,255,255,.07);
      --fg:#e8edf7; --muted:#a9b2c7; --primary:#60a5fa; --accent:#67e8f9; --ok:#34d399; --danger:#ef476f;
      --shadow:0 10px 30px rgba(0,0,0,.45); --ring:0 0 0 3px rgba(96,165,250,.35);
      --r-lg:22px; --r-md:14px; --r-sm:10px; --space:clamp(14px,3.2vw,20px);
      --content:max(280px, min(100vw, 780px));
      /* Colori ruoli */
      --c-spy:#ef476f;         /* Spia */
      --c-fake:#f59e0b;        /* Finta Spia */
      --c-law:#34d399;         /* Avvocato */
      --c-civ:#60a5fa;         /* Civile */
    }
    [data-theme="light"]:root{
      --bg:#f8fafc; --surface:#ffffff; --surface-2:#eef2ff; --line:rgba(13,15,26,.06);
      --fg:#0d1224; --muted:#64748b; --primary:#2563eb; --accent:#06b6d4; --ok:#16a34a; --danger:#dc2626;
      --shadow:0 8px 28px rgba(2,6,23,.08); --ring:0 0 0 3px rgba(37,99,235,.22);
      --c-spy:#dc2626; --c-fake:#d97706; --c-law:#16a34a; --c-civ:#2563eb;
    }
    html,body{height:100%}
    body{margin:0;color:var(--fg);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.35;-webkit-font-smoothing:antialiased}

    /* Background */
    .bg{position:fixed;inset:0;pointer-events:none;z-index:-2;
      background:
        radial-gradient(800px 420px at 120% -10%, rgba(103,232,249,.12), transparent 60%),
        radial-gradient(700px 400px at -20% 110%, rgba(96,165,250,.15), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--surface-2) 40%, var(--bg) 90%);
    }
    .grain{position:fixed;inset:0;pointer-events:none;z-index:-1;opacity:.22;mix-blend-mode:soft-light;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 40 40"><g fill="%23ffffff" fill-opacity="0.025"><circle cx="2" cy="2" r="1"/><circle cx="6" cy="18" r="1"/><circle cx="14" cy="6" r="1"/><circle cx="22" cy="30" r="1"/><circle cx="36" cy="12" r="1"/></g></svg>');
    }

    /* Layout */
    header{ /* NON sticky: richiesto */
      position:relative; top:auto; z-index:20; border-bottom:1px solid var(--line);
      background:color-mix(in oklab, var(--surface), transparent 30%);
    }
    .bar{max-width:var(--content);margin:0 auto;padding:10px var(--space);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:nowrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand h1{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:900;color:#0d0f1a;background:conic-gradient(from 210deg,var(--accent),var(--primary),#a78bfa,var(--accent));box-shadow:0 10px 24px rgba(103,232,249,.25);flex:0 0 auto}
    .controls{display:flex;align-items:center;gap:8px;flex:0 0 auto}
    .wrap{max-width:var(--content);margin:0 auto;padding:calc(var(--space) + env(safe-area-inset-top)) var(--space) calc(84px + env(safe-area-inset-bottom));}

    h1{font-size:18px;margin:0}
    h2{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .note{font-size:.88rem;color:var(--muted)}

    /* Controls */
    select,input[type=text],input[type=number],textarea{width:100%;padding:14px;background:var(--surface-2);color:var(--fg);border:1px solid var(--line);border-radius:var(--r-md);font-size:16px;outline:none}
    select:focus,input:focus,textarea:focus{box-shadow:var(--ring);border-color:color-mix(in srgb,var(--primary),transparent 50%)}
    .btn{appearance:none;-webkit-tap-highlight-color:transparent;cursor:pointer;border:none;border-radius:999px;padding:12px 16px;font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow);background:var(--primary);color:#0d0f1a;position:relative;overflow:hidden}
    .btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--line)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.ok{background:var(--ok);color:#0d0f1a}
    .btn.secondary{background:color-mix(in srgb,var(--primary),var(--accent) 40%)}

    /* Cards + Accordion */
    .card{background:linear-gradient(180deg,var(--surface),var(--surface-2));border:1px solid var(--line);border-radius:var(--r-lg);padding:18px;box-shadow:var(--shadow);transform:translateY(6px) scale(.98);opacity:0;transition:transform .5s cubic-bezier(.2,.7,.2,1),opacity .5s}
    .card.in{transform:translateY(0) scale(1);opacity:1}
    .section-title{display:flex;align-items:center;gap:8px;margin:0 0 8px}
    .accordion{border-radius:var(--r-lg);overflow:hidden}
    .acc-head{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;padding:14px 16px;background:var(--surface-2);border:1px solid var(--line);border-radius:14px;margin-bottom:10px}
    .acc-head h2{margin:0;font-size:18px}
    .acc-body{display:block}
    .acc-body.collapsed{display:none}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.nowrap{flex-wrap:nowrap}
    .grow{flex:1 1 auto}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .list li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:var(--surface-2);border:1px solid var(--line);border-radius:14px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--surface-2);border:1px solid var(--line)}
    .timer{font-variant-numeric:tabular-nums;font-weight:900;font-size:clamp(42px,14vw,86px)}

    /* Views */
    [data-view]{display:none}
    [data-view].show{display:block}

    /* Hero */
    .hero{text-align:center;padding:24px 10px 8px}
    .hero h2{font-size:clamp(28px,8.5vw,40px)}
    .hero p{margin:0 auto 14px;max-width:34ch}
    .cta{display:flex;gap:10px;justify-content:center}

    /* Role card */
    .role-card{display:grid;place-items:center;min-height:340px;border-radius:var(--r-lg);background:var(--surface-2);border:1px dashed var(--line);user-select:none;transform-style:preserve-3d;transition:transform .12s ease;padding:28px}
    .role-card.revealed{border-style:solid}
    .role-title{font-size:1.1rem;margin:0 0 6px}
    .role-strong{font-weight:900}
    .role-name{font-size:1.25rem;font-weight:900;margin:6px 0}
    .role-word{font-weight:900}

    /* Modals (no alert/confirm di sistema) */
    dialog{border:none;padding:0;border-radius:20px;background:linear-gradient(180deg,var(--surface),var(--surface-2));color:var(--fg);width:min(680px,92vw);box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
    .modal-head{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:18px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:0 18px 16px}

    /* FX */
    #fxConfetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    footer{opacity:.8;padding:18px;text-align:center;font-size:.92rem}

    /* Badges di ruolo */
    .badge{display:inline-flex;align-items:center;font-weight:800;padding:6px 10px;border-radius:999px}
    .b-spy{background:color-mix(in srgb, var(--c-spy), #000 10%); color:#fff}
    .b-fake{background:color-mix(in srgb, var(--c-fake), #000 10%); color:#0d0f1a}
    .b-law{background:color-mix(in srgb, var(--c-law), #000 8%); color:#0d0f1a}
    .b-civ{background:color-mix(in srgb, var(--c-civ), #000 8%); color:#0d0f1a}

    /* Mobile header: tutto su una riga */
    @media (max-width:480px){
      .bar{gap:8px}
      .brand h1{font-size:16px}
      .controls select{max-width:74px}
      .btn{padding:12px 14px}
      .acc-head{padding:12px 14px}
      .role-card{min-height:300px;padding:24px}
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="card in" style="text-align:center;max-width:320px">
      <div class="logo" style="width:64px;height:64px;margin-inline:auto">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
      <h2 style="margin:8px 0 4px">Gioco Spia</h2>
      <p class="muted" style="margin:0">Ready ‚Ä¢ Set ‚Ä¢ Suspect</p>
    </div>
  </div>

  <header>
    <div class="bar">
      <button class="logo btn ghost" id="homeBtn" title="Home" aria-label="Home" style="box-shadow:none">üïµÔ∏è‚Äç‚ôÇÔ∏è</button>
      <div class="brand" style="cursor:pointer" id="titleBtn" title="Vai alla home">
        <h1 id="appTitle">Gioco Spia</h1>
      </div>
      <div class="controls">
        <button id="themeBtn" class="btn ghost" title="Tema">üåì</button>
        <select id="lang" aria-label="Lingua">
          <option value="it">üáÆüáπ IT</option>
          <option value="en">üá¨üáß EN</option>
        </select>
        <button id="helpBtn" class="btn ghost" title="Regole">‚ùì</button>
      </div>
    </div>
  </header>

  <canvas id="fxConfetti"></canvas>

  <main class="wrap">
    <!-- Landing -->
    <section data-view id="view-landing" class="show">
      <div class="card in hero">
        <h2 id="heroTitle">Il party game in tasca</h2>
        <p id="heroDesc">Spie, Finta Spia e Avvocato. UI moderna, salvataggio locale, nessun account.</p>
        <div class="cta">
          <button id="goStart" class="btn secondary">üöÄ <span data-i="startNow">Inizia</span></button>
          <button id="goHow" class="btn ghost">üìú <span data-i="rules">Istruzioni</span></button>
        </div>
      </div>

      <!-- RIMOSSA la card ‚ÄúMobile‚Äëfirst‚Äù come richiesto -->
      <div class="card"><h3 class="section-title">üß† <span>Ruoli speciali</span></h3>
        <p class="muted">Spia, Finta Spia, Avvocato, Civile. Timer & votazione integrati.</p>
        <p class="note">üíæ Salvataggio automatico: giocatori, impostazioni e categorie restano nel tuo browser.</p>
      </div>
    </section>

    <!-- Setup -->
    <section data-view id="view-home">
      <div class="accordion">
        <!-- Giocatori -->
        <div class="acc-head" data-acc="players"><h2>üë• <span data-i="players">Giocatori</span> (<span id="playersCount">0</span>)</h2><span class="muted">riduci/espandi</span></div>
        <div class="acc-body" id="acc-players">
          <div class="card">
            <div class="row nowrap">
              <input id="playerInput" class="grow" type="text" maxlength="24" placeholder="Nome giocatore" />
              <button id="addPlayer" class="btn">‚ûï Aggiungi giocatore</button>
            </div>
            <ul id="playersList" class="list" aria-label="Lista giocatori"></ul>
            <div class="row">
              <button id="shufflePlayers" class="btn ghost">üîÄ <span data-i="shuffle">Mescola</span></button>
              <button id="clearPlayers" class="btn danger">üóëÔ∏è <span data-i="clear">Svuota</span></button>
            </div>
            <p class="note" style="margin-top:8px">üíæ Salvataggio automatico dei giocatori.</p>
          </div>
        </div>

        <!-- Categorie -->
        <div class="acc-head" data-acc="cats"><h2>üìö <span data-i="categories">Categorie</span></h2><span class="muted">riduci/espandi</span></div>
        <div class="acc-body" id="acc-cats">
          <div class="card">
            <div class="row">
              <select id="categorySelect" class="grow" aria-label="Categoria"></select>
              <button id="openCats" class="btn ghost">üîß <span data-i="manage">Gestisci</span></button>
            </div>
            <p class="muted" id="selectedCategoryView">üìå <span data-i="selectedCat">Categoria selezionata</span>: <strong id="selCatTxt">‚Äî</strong></p>
            <p class="note">üíæ Le categorie personalizzate sono salvate automaticamente per lingua.</p>
          </div>
        </div>

        <!-- Impostazioni -->
        <div class="acc-head" data-acc="settings"><h2>‚öôÔ∏è <span data-i="gameSettings">Impostazioni</span></h2><span class="muted">riduci/espandi</span></div>
        <div class="acc-body" id="acc-settings">
          <div class="card">
            <div class="row">
              <div class="grow">
                <label for="numSpies">üïµÔ∏è <span data-i="numSpies">Spie</span></label>
                <div class="row"><input id="numSpies" type="number" min="1" max="4" step="1" value="1" />
                  <button class="btn ghost" data-step="numSpies" data-delta="-1">‚Äì</button>
                  <button class="btn ghost" data-step="numSpies" data-delta="1">+</button>
                </div>
              </div>
              <div class="grow">
                <label for="numFakeSpies">üé≠ <span data-i="numFakeSpies">Finte spie</span></label>
                <div class="row"><input id="numFakeSpies" type="number" min="0" max="4" step="1" value="0" />
                  <button class="btn ghost" data-step="numFakeSpies" data-delta="-1">‚Äì</button>
                  <button class="btn ghost" data-step="numFakeSpies" data-delta="1">+</button>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="grow">
                <label for="numLawyers">‚öñÔ∏è <span data-i="numLawyers">Avvocati</span></label>
                <div class="row"><input id="numLawyers" type="number" min="0" max="2" step="1" value="0" />
                  <button class="btn ghost" data-step="numLawyers" data-delta="-1">‚Äì</button>
                  <button class="btn ghost" data-step="numLawyers" data-delta="1">+</button>
                </div>
              </div>
              <div class="grow">
                <label for="roundMinutes">‚è±Ô∏è <span data-i="roundMinutes">Minuti</span></label>
                <div class="row"><input id="roundMinutes" type="number" min="1" max="20" step="1" value="5" />
                  <button class="btn ghost" data-step="roundMinutes" data-delta="-1">‚Äì</button>
                  <button class="btn ghost" data-step="roundMinutes" data-delta="1">+</button>
                </div>
              </div>
            </div>
            <p class="muted" id="rolesHint">üí° <span data-i="rolesHint">I ruoli speciali totali devono essere minori dei giocatori.</span></p>
            <div class="row">
              <button id="saveSettings" class="btn ok">üíæ <span data-i="save">Salva</span></button>
              <span class="chip" id="summaryPill" aria-live="polite"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Avvio -->
      <div class="card">
        <h2 class="section-title">üöÄ <span data-i="start">Avvia partita</span></h2>
        <p class="muted"><span data-i="preflight">Assicurati di avere almeno 3 giocatori e una categoria con parole.</span></p>
        <div class="row">
          <button id="startGameMain" class="btn secondary">‚ñ∂Ô∏è <span data-i="startNow">Inizia ora</span></button>
          <button id="howToBtn" class="btn ghost">üìú <span data-i="rules">Regole</span></button>
        </div>
      </div>
    </section>

    <!-- Gestione categorie -->
    <section data-view id="view-cats">
      <div class="card"><h2 class="section-title">üìö <span data-i="manageCats">Gestisci categorie</span></h2>
        <div class="row"><button id="backHomeFromCats" class="btn ghost">‚Üê <span data-i="back">Indietro</span></button></div>
      </div>
      <div class="card"><h3 class="section-title">üß© <span data-i="yourCats">Le tue categorie</span></h3>
        <ul id="customCatsList" class="list"></ul>
      </div>
      <div class="card"><h3 class="section-title">‚ûï <span data-i="newCat">Nuova categoria</span></h3>
        <div class="row"><input id="catName" class="grow" type="text" placeholder="Nome categoria (es. Film)" /></div>
        <div class="row"><textarea id="catWords" rows="3" placeholder="Parole separate da virgola o a capo"></textarea></div>
        <div class="row"><button id="saveCategory" class="btn ok">üíæ <span data-i="save">Salva</span></button></div>
        <p class="note" style="margin-top:6px">üíæ Salvataggio automatico nel browser (per lingua).</p>
      </div>
      <div class="card"><h3 class="section-title">üì¶ <span data-i="stockCats">Categorie predefinite</span></h3>
        <ul id="stockCatsList" class="list"></ul>
      </div>
    </section>

    <!-- Ruoli -->
    <section data-view id="view-roles">
      <div class="card">
        <h2 class="section-title">ü™™ <span data-i="assign">Assegnazione ruoli</span></h2>
        <p id="currentPlayerLbl" class="muted"></p>
        <div class="role-card" id="roleCard" tabindex="0" aria-live="polite" aria-label="Carta ruolo">
          <span class="muted"><span data-i="clickRole">Clicca o premi Invio per vedere il tuo ruolo</span></span>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="nextPlayer" class="btn secondary" disabled>‚û°Ô∏è <span data-i="next">Prossimo</span></button>
        </div>
      </div>
    </section>

    <!-- Gioco -->
    <section data-view id="view-game">
      <div class="card" style="text-align:center">
        <h2 class="section-title" style="justify-content:center">üéÆ <span data-i="live">Gioco in corso</span></h2>
        <p id="firstQuestionHint" class="note" style="margin-bottom:6px"></p>
        <p class="note" style="margin-top:0">‚ÑπÔ∏è Iniziate a fare domande per scoprire chi √® la spia.</p>
        <div class="timer" id="timer">05:00</div>
        <div class="row" style="justify-content:center;gap:10px;margin-top:8px">
          <button id="pauseTimer" class="btn ghost">‚è∏Ô∏è <span data-i="pause">Pausa</span></button>
          <button id="endRound" class="btn danger">‚è∞ <span data-i="endRound">Termina round</span></button>
        </div>
      </div>
    </section>

    <!-- Voto -->
    <section data-view id="view-vote">
      <div class="card">
        <h2 class="section-title">üó≥Ô∏è <span data-i="voting">Votazione</span></h2>
        <ul id="voteList" class="list" aria-label="Sospetti da votare"></ul>
        <div class="row"><button id="seeResults" class="btn secondary">üìä <span data-i="seeResults">Mostra risultati</span></button></div>
      </div>
    </section>

    <!-- Risultati -->
    <section data-view id="view-results">
      <div class="card">
        <h2 class="section-title">üìà <span data-i="results">Risultati</span></h2>
        <div id="resultsBox"></div>
        <div class="row" style="margin-top:12px">
          <button id="revealAll" class="btn ghost">üÉè <span data-i="reveal">Rivela tutti i ruoli</span></button>
          <button id="restart" class="btn ok">üîÑ <span data-i="playAgain">Gioca di nuovo</span></button>
        </div>
      </div>
    </section>
  </main>

  <footer class="wrap">
    <span style="font-size:.9rem">¬© 2025 ‚Ä¢ <span data-i="footer">Gioco locale: i dati restano nel tuo browser.</span></span>
  </footer>

  <!-- Modale: Istruzioni -->
  <dialog id="modalHelp" aria-labelledby="helpTitle">
    <div class="modal-head"><strong id="helpTitle">üìú Regole</strong><button class="btn ghost" id="closeHelp">‚úï</button></div>
    <div class="modal-body"><div id="helpContent" class="muted"></div></div>
  </dialog>

  <!-- Modale: Toast/Info/Confirm -->
  <dialog id="modal" aria-live="polite">
    <div class="modal-head"><strong id="modalTitle">Info</strong><button class="btn ghost" id="modalClose">‚úï</button></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions" id="modalActions" style="display:none"></div>
  </dialog>

  <script>
    // ====== Utils ======
    const LS={get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):(f??null)}catch{return f??null}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}},del:k=>{try{localStorage.removeItem(k)}catch{}}};
    const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
    const Role={spy:'spy',fake:'fake',law:'law',civ:'civ'};
    const roleLabel=(r,lang)=> lang==='it' ? (r===Role.spy?'Spia':r===Role.fake?'Finta Spia':r===Role.law?'Avvocato':'Civile') : (r===Role.spy?'Spy':r===Role.fake?'Fake Spy':r===Role.law?'Lawyer':'Civilian');
    const roleBadgeCls=r=> r===Role.spy?'b-spy':r===Role.fake?'b-fake':r===Role.law?'b-law':'b-civ';

    // i18n
    const T={
      it:{appTitle:"Gioco Spia",startNow:"Inizia",rules:"Istruzioni",players:"Giocatori",shuffle:"Mescola",clear:"Svuota",categories:"Categorie",manage:"Gestisci",gameSettings:"Impostazioni",numSpies:"Spie",numFakeSpies:"Finte spie",numLawyers:"Avvocati",roundMinutes:"Minuti",rolesHint:"I ruoli speciali totali devono essere minori dei giocatori.",save:"Salva",start:"Avvia partita",preflight:"Assicurati di avere almeno 3 giocatori e una categoria con parole.",selectedCat:"Categoria selezionata",manageCats:"Gestisci categorie",yourCats:"Le tue categorie",newCat:"Nuova categoria",stockCats:"Categorie predefinite",back:"Indietro",assign:"Assegnazione ruoli",clickRole:"Clicca o premi Invio per vedere il tuo ruolo",next:"Prossimo",live:"Gioco in corso",pause:"Pausa",endRound:"Termina round",voting:"Votazione",seeResults:"Mostra risultati",results:"Risultati",reveal:"Rivela tutti i ruoli",playAgain:"Gioca di nuovo",footer:"Gioco locale: i dati restano nel tuo browser.",errs_need3:"Devi avere almeno 3 giocatori.",errs_roles:"I ruoli speciali totali devono essere minori del numero di giocatori.",errs_cat:"Seleziona una categoria con almeno una parola.",saved:"Impostazioni salvate!",words:"parole",lawyerText:(w,s)=>`Sei l'Avvocato! La parola √® "<span class="role-word">${w}</span>" e le spie sono: <b>${s}</b>.`,spyText:()=>"Sei la <span class='role-strong'>Spia</span>!",fakeText:w=>`Sei la <span class='role-strong'>Finta Spia</span>! Parola: <span class="role-word">${w}</span>`,civText:w=>`Sei un <span class='role-strong'>Civile</span>! La parola √®: <span class="role-word">${w}</span>`,timerUp:"Tempo scaduto! Si va al voto.",confirmVote:p=>`Confermi il voto per ${p}?`,voted:p=>`Hai votato per ${p}.`,eliminated:(p,r)=>`${p} eliminat* ‚Äî era ${r}.`,civsWin:"I Civili vincono!",spiesWin:"Le Spie vincono!",rolesLegend:"Legenda ruoli",legendHTML:`<span class="badge b-spy">üïµÔ∏è Spia</span> ¬∑ <span class="badge b-fake">üé≠ Finta Spia</span> ¬∑ <span class="badge b-law">‚öñÔ∏è Avvocato</span> ¬∑ <span class="badge b-civ">üë§ Civile</span>`,helpHTML:`<p><strong>Obiettivo</strong> ‚Äî Indovinare chi √® la <em>Spia</em>.</p><p><strong>Ruoli</strong><br>üïµÔ∏è <b>Spia</b>: non vede la parola. Vince se al voto viene eliminato un non‚Äëspia.<br>üé≠ <b>Finta Spia</b>: vede la parola ma gioca con le Spie (depista i Civili).<br>‚öñÔ∏è <b>Avvocato</b>: vede parola e identit√† delle Spie. √à con i Civili.<br>üë§ <b>Civile</b>: vede la parola.</p><p><strong>Round</strong> ‚Äî 1) Assegna ruoli. 2) Discussione. 3) Voto unico. 4) Eliminazione. Se √® (Finta) Spia ‚Üí Civili vincono; altrimenti Spie.</p>`,mustReveal:"Prima leggi il tuo ruolo toccando la carta."},
      en:{appTitle:"Spy Game",startNow:"Start",rules:"Rules",players:"Players",shuffle:"Shuffle",clear:"Clear",categories:"Categories",manage:"Manage",gameSettings:"Settings",numSpies:"Spies",numFakeSpies:"Fake spies",numLawyers:"Lawyers",roundMinutes:"Minutes",rolesHint:"Special roles total must be less than players.",save:"Save",start:"Start match",preflight:"Make sure you have at least 3 players and a category with words.",selectedCat:"Selected category",manageCats:"Manage categories",yourCats:"Your categories",newCat:"New category",stockCats:"Default categories",back:"Back",assign:"Assign roles",clickRole:"Click or press Enter to see your role",next:"Next",live:"Game in progress",pause:"Pause",endRound:"End round",voting:"Voting",seeResults:"Show results",results:"Results",reveal:"Reveal all roles",playAgain:"Play again",footer:"Local game: data stays in your browser.",errs_need3:"You need at least 3 players.",errs_roles:"Special roles total must be less than the number of players.",errs_cat:"Select a category with at least one word.",saved:"Settings saved!",words:"words",lawyerText:(w,s)=>`You are the Lawyer! The word is "<span class="role-word">${w}</span>" and the spies are: <b>${s}</b>.`,spyText:()=>"You are the <span class='role-strong'>Spy</span>!",fakeText:w=>`You are the <span class='role-strong'>Fake Spy</span>! Word: <span class="role-word">${w}</span>`,civText:w=>`You are a <span class='role-strong'>Civilian</span>! The word is: <span class="role-word">${w}</span>`,timerUp:"Time is up! Voting time.",confirmVote:p=>`Confirm vote for ${p}?`,voted:p=>`You voted for ${p}.`,eliminated:(p,r)=>`${p} eliminated ‚Äî was ${r}.`,civsWin:"Civilians win!",spiesWin:"Spies win!",rolesLegend:"Roles legend",legendHTML:`<span class="badge b-spy">üïµÔ∏è Spy</span> ¬∑ <span class="badge b-fake">üé≠ Fake Spy</span> ¬∑ <span class="badge b-law">‚öñÔ∏è Lawyer</span> ¬∑ <span class="badge b-civ">üë§ Civilian</span>`,helpHTML:`<p><strong>Goal</strong> ‚Äî Find the <em>Spy</em>.</p><p><strong>Roles</strong>‚Ä¶</p>`,mustReveal:"Please reveal your role first by tapping the card."}
    };

    const STOCK={
      it:{"Animali":["Cane","Gatto","Elefante","Leone","Tigre","Giraffa","Zebra","Scimmia","Orso","Lupo","Volpe","Pinguino","Delfino","Aquila","Gufo"],"Cibo":["Pizza","Pasta","Gelato","Sushi","Hamburger","Lasagna","Risotto","Tiramis√π","Cioccolato","Formaggio"],"Sport":["Calcio","Basket","Nuoto","Tennis","Rugby","Volley","Ciclismo","Atletica","Sci","Pattinaggio"],"Luoghi":["Bar","Ospedale","Scuola","Parco","Museo","Biblioteca","Cinema","Ristorante","Aeroporto","Stadio"],"Professioni":["Medico","Ingegnere","Avvocato","Insegnante","Poliziotto","Pompiere","Architetto","Cuoco","Pilota","Musicista"]},
      en:{"Animals":["Dog","Cat","Elephant","Lion","Tiger","Giraffe","Zebra","Monkey","Bear","Wolf","Fox","Penguin","Dolphin","Eagle","Owl"],"Food":["Pizza","Pasta","Ice Cream","Sushi","Hamburger","Lasagna","Risotto","Tiramisu","Chocolate","Cheese"],"Sports":["Football","Basketball","Swimming","Tennis","Rugby","Volleyball","Cycling","Athletics","Skiing","Skating"],"Places":["Bar","Hospital","School","Park","Museum","Library","Cinema","Restaurant","Airport","Stadium"],"Professions":["Doctor","Engineer","Lawyer","Teacher","Police Officer","Firefighter","Architect","Cook","Pilot","Musician"]}
    };

    const state={
      lang:LS.get('lang','it'),
      theme:LS.get('theme','auto'),
      players:LS.get('players',[]),
      custom:LS.get('custom_'+(LS.get('lang','it')||'it'),{}),
      category:LS.get('category',''),
      settings:LS.get('settings',{spies:1,fakes:0,laws:0,minutes:5}),
      game:null
    };

    // Theme
    function metaThemeSync(){const meta=$('#metaTheme');meta.content=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();}
    function applyTheme(){const root=document.documentElement; if(state.theme==='auto'){const dark=matchMedia('(prefers-color-scheme: dark)').matches; root.setAttribute('data-theme',dark?'dark':'light');} else {root.setAttribute('data-theme',state.theme);} metaThemeSync();}
    function cycleTheme(){state.theme=state.theme==='auto'?'light':state.theme==='light'?'dark':'auto'; LS.set('theme',state.theme); $('#themeBtn').textContent=state.theme==='auto'?'üåì':state.theme==='light'?'‚òÄÔ∏è':'üåô'; applyTheme();}
    matchMedia('(prefers-color-scheme: dark)').addEventListener?.('change',()=>{if(state.theme==='auto') applyTheme();});

    // i18n
    function i18nRefresh(){
      const t=T[state.lang];
      $('#appTitle').textContent=t.appTitle;
      $$('#lang option').forEach(o=>o.selected=(o.value===state.lang));
      $('#heroTitle').textContent=state.lang==='it'?'Il party game in tasca':'The party game in your pocket';
      $('#heroDesc').textContent=state.lang==='it'?'Spie, Fake Spy e Avvocato. UI moderna, salvataggio locale, nessun account.':'Spies, Fake Spy & Lawyer. Modern UI, local save, no account.';
      $$('[data-i]').forEach(el=>{const k=el.getAttribute('data-i'); el.textContent=t[k]??el.textContent});
      $('#playerInput').placeholder=state.lang==='it'?'Nome giocatore':'Player name';
      $('#catName').placeholder=state.lang==='it'?'Nome categoria (es. Film)':'Category name (e.g., Movies)';
      $('#catWords').placeholder=state.lang==='it'?'Parole separate da virgola o a capo':'Words separated by comma or newline';
      $('#helpTitle').textContent=state.lang==='it'?'Istruzioni':'Rules';
      $('#helpContent').innerHTML=t.helpHTML;
      renderCategories(); renderSummaryPill(); updateSelectedCatView(); renderPlayers(); renderCatsPage(); revealOnScroll();
    }

    // Toast/Modal (no alert/confirm)
    function modalInfo(html,actions){
      const d=$('#modal'); if(!d||typeof d.showModal!=='function'){return;}
      $('#modalTitle').textContent='';
      $('#modalBody').innerHTML=html;
      const act=$('#modalActions');
      act.innerHTML=''; act.style.display=actions&&actions.length?'flex':'none';
      (actions||[]).forEach(a=>{
        const b=document.createElement('button');
        b.className='btn '+(a.kind||'secondary'); b.textContent=a.label;
        b.onclick=()=>{a.onClick?.(); d.close();}
        act.appendChild(b);
      });
      d.showModal();
    }
    function toast(msg){modalInfo(`<p>${msg}</p>`);}

    // Players
    function renderPlayers(){
      const ul=$('#playersList'); if(!ul) return; ul.innerHTML='';
      state.players.forEach((p,idx)=>{
        const li=document.createElement('li');
        li.innerHTML=`<span>${p}</span>
          <span class="row">
            <button class="btn ghost" data-move="-1" title="Su">‚¨ÜÔ∏è</button>
            <button class="btn ghost" data-move="1" title="Gi√π">‚¨áÔ∏è</button>
            <button class="btn danger" title="Rimuovi">‚úï</button>
          </span>`;
        li.querySelector('[data-move="-1"]').onclick=()=>{if(idx>0){[state.players[idx-1],state.players[idx]]=[state.players[idx],state.players[idx-1]]; savePlayers(); renderPlayers();}};
        li.querySelector('[data-move="1"]').onclick=()=>{if(idx<state.players.length-1){[state.players[idx+1],state.players[idx]]=[state.players[idx],state.players[idx+1]]; savePlayers(); renderPlayers();}};
        li.querySelector('.btn.danger').onclick=()=>{state.players.splice(idx,1); savePlayers(); renderPlayers();};
        ul.appendChild(li);
      });
      $('#playersCount').textContent=state.players.length;
    }
    function addPlayer(){const v=$('#playerInput').value.trim(); if(!v) return; if(state.players.includes(v)){ $('#playerInput').value=''; return;} state.players.push(v); $('#playerInput').value=''; savePlayers(); renderPlayers();}
    function savePlayers(){LS.set('players',state.players)}

    // Categories
    const STOCK_ALL=()=>STOCK[state.lang];
    function allCategories(){return {...STOCK_ALL(), ...(state.custom||{})}}
    function renderCategories(){
      const sel=$('#categorySelect'); if(!sel) return; sel.innerHTML='';
      const cats=allCategories(); const ph=document.createElement('option');
      ph.disabled=true; ph.selected=!state.category; ph.textContent=state.lang==='it'?'Seleziona una categoria':'Select a category'; sel.appendChild(ph);
      Object.keys(cats).sort().forEach(cat=>{
        const o=document.createElement('option'); o.value=cat; o.textContent=`${cat} (${cats[cat].length} ${T[state.lang].words})`; if(cat===state.category) o.selected=true; sel.appendChild(o)
      });
      updateSelectedCatView();
    }
    function updateSelectedCatView(){const el=$('#selCatTxt'); if(el) el.textContent=state.category||'‚Äî'}

    function renderCatsPage(){
      const customUl=$('#customCatsList'); const stockUl=$('#stockCatsList'); if(!customUl||!stockUl) return;
      customUl.innerHTML=''; stockUl.innerHTML='';
      const custom=state.custom||{}; const stock=STOCK_ALL();
      Object.keys(custom).sort().forEach(cat=>{
        const li=document.createElement('li');
        li.innerHTML=`<span>${cat} <span class="muted">(${custom[cat].length})</span></span>
                      <span class="row">
                        <button class="btn ghost" data-edit>‚úèÔ∏è</button>
                        <button class="btn danger" data-del>‚úï</button>
                      </span>`;
        li.querySelector('[data-edit]').onclick=()=>openEditor(cat);
        li.querySelector('[data-del]').onclick=()=>{ modalInfo(`<p>${state.lang==='it'?'Eliminare la categoria':"Delete category"} "<b>${cat}</b>"?</p>`,[
          {label: state.lang==='it'?'Annulla':'Cancel', kind:'ghost'},
          {label: state.lang==='it'?'Elimina':'Delete', kind:'danger', onClick:()=>{ delete custom[cat]; state.custom=custom; LS.set('custom_'+state.lang,custom); if(state.category===cat) state.category=''; renderCategories(); renderCatsPage(); }}
        ]); };
        customUl.appendChild(li);
      });
      Object.keys(stock).sort().forEach(cat=>{
        const li=document.createElement('li'); li.innerHTML=`<span>${cat} <span class="muted">(${stock[cat].length})</span></span><span class="chip">Predefinita</span>`; stockUl.appendChild(li);
      });
    }
    function parseWords(txt){return [...new Set(txt.split(/[\n,;]+|,(?=(?:[^"]*"[^"]*")*[^"]*$)/g).join('\n').split(/\s+/).map(s=>s.trim()).filter(Boolean))]}
    function saveNewCategory(){
      const name=$('#catName').value.trim(); if(!name) return;
      const words=parseWords($('#catWords').value); if(words.length===0) return;
      if(!state.custom) state.custom={}; if(!state.custom[name]) state.custom[name]=[];
      state.custom[name].push(...words.filter(w=>!state.custom[name].includes(w)));
      LS.set('custom_'+state.lang,state.custom);
      $('#catName').value=''; $('#catWords').value='';
      renderCategories(); renderCatsPage(); toast(state.lang==='it'?'Categoria salvata!':'Category saved!');
    }
    function openEditor(cat){
      const ul=$('#customCatsList'); [...ul.children].forEach(li=>li.classList.remove('editing'));
      const li=[...ul.children].find(el=> el.firstChild && el.firstChild.textContent.trim().startsWith(cat)); if(!li) return;
      li.classList.add('editing');
      const box=document.createElement('div'); box.style.marginTop='10px';
      box.innerHTML=`<div class="row"><input id="wInput" class="grow" type="text" placeholder="${state.lang==='it'?'Aggiungi parola e premi Invio':'Add word and press Enter'}"/></div><div id="wChips" class="row" style="flex-wrap:wrap;gap:8px;margin-top:8px"></div>`;
      li.appendChild(box);
      const chips=$('#wChips');
      function draw(){
        chips.innerHTML='';
        (state.custom[cat]||[]).forEach((w,i)=>{
          const c=document.createElement('span'); c.className='chip'; c.innerHTML=`${w} <button class="btn danger" style="padding:4px 8px">√ó</button>`;
          c.querySelector('button').onclick=()=>{state.custom[cat].splice(i,1); LS.set('custom_'+state.lang,state.custom); draw(); renderCategories();};
          chips.appendChild(c);
        });
      }
      draw();
      box.querySelector('#wInput').addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          const v=e.target.value.trim(); if(!v) return;
          if(!state.custom[cat].includes(v)) state.custom[cat].push(v);
          e.target.value=''; LS.set('custom_'+state.lang,state.custom); draw(); renderCategories();
        }
      });
    }

    // Settings
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,Number(n||0)));
    function readSettings(){const spies=clamp($('#numSpies').value,1,4); const fakes=clamp($('#numFakeSpies').value,0,4); const laws=clamp($('#numLawyers').value,0,2); const minutes=clamp($('#roundMinutes').value,1,20); return {spies,fakes,laws,minutes}};
    function writeSettings(s){$('#numSpies').value=s.spies; $('#numFakeSpies').value=s.fakes; $('#numLawyers').value=s.laws; $('#roundMinutes').value=s.minutes; renderSummaryPill();}
    function saveSettings(){state.settings=readSettings(); LS.set('settings',state.settings); toast(T[state.lang].saved); renderSummaryPill();}
    function renderSummaryPill(){const s=state.settings; $('#summaryPill').textContent=`üïµÔ∏è ${s.spies} ¬∑ üé≠ ${s.fakes} ¬∑ ‚öñÔ∏è ${s.laws} ¬∑ ‚è±Ô∏è ${s.minutes}‚Ä≤`; }

    // Game
    function startGame(){
      // preflight
      const s=readSettings();
      const cats=allCategories(); const words=(state.category && cats[state.category])?cats[state.category]:[];
      if(state.players.length<3){ scrollToSection('players'); return toast(T[state.lang].errs_need3); }
      if(s.spies+s.fakes+s.laws>=state.players.length){ scrollToSection('settings'); return toast(T[state.lang].errs_roles); }
      if(!state.category||words.length===0){ scrollToSection('cats'); return toast(T[state.lang].errs_cat); }

      state.settings=s; LS.set('settings',s); LS.set('category',state.category);

      // pick word + shuffle players/roles
      const secret=words[Math.floor(Math.random()*words.length)];
      const order=[...state.players]; for(let i=order.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [order[i],order[j]]=[order[j],order[i]]}
      const roles=[]; for(let i=0;i<s.spies;i++) roles.push(Role.spy); for(let i=0;i<s.fakes;i++) roles.push(Role.fake); for(let i=0;i<s.laws;i++) roles.push(Role.law);
      while(roles.length<order.length) roles.push(Role.civ);
      for(let i=roles.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [roles[i],roles[j]]=[roles[j],roles[i]]}
      const spyNames=roles.map((r,i)=> (r===Role.spy||r===Role.fake)?order[i]:null).filter(Boolean);
      state.game={order,roles,secret,spyNames,index:0,timer:null,time:s.minutes*60,votes:{},finished:false, revealed:false};

      showView('view-roles'); showNextRole();
    }

    function showNextRole(){
      const g=state.game; if(!g) return;
      if(g.index>=g.order.length){ showView('view-game'); startTimer(); setFirstQuestion(); return; }
      const name=g.order[g.index];
      // ‚ÄúNome del giocatore‚Äù in singolare, grande e bold
      $('#currentPlayerLbl').innerHTML = (state.lang==='it'?'Nome del giocatore: ':'Player: ') + `<span class="role-name">${name}</span>`;
      const card=$('#roleCard'); card.classList.remove('revealed'); g.revealed=false;
      card.innerHTML=`<div style="text-align:center">
        <p class="role-title muted">${T[state.lang].clickRole}</p>
        <p class="muted" style="margin-top:8px">${T[state.lang].rolesLegend}: ${T[state.lang].legendHTML}</p>
      </div>`;
      $('#nextPlayer').disabled=true;

      function reveal(){
        if(g.revealed) return; // niente doppio reveal
        const role=g.roles[g.index];
        g.revealed=true;
        card.classList.add('revealed');
        // testo con parole/ruolo in grassetto e badge colore
        let desc='';
        if(role===Role.civ) desc=T[state.lang].civText(g.secret);
        else if(role===Role.spy) desc=T[state.lang].spyText();
        else if(role===Role.fake) desc=T[state.lang].fakeText(g.secret);
        else if(role===Role.law) desc=T[state.lang].lawyerText(g.secret,g.spyNames.join(', '));
        card.innerHTML=`<div style="text-align:center">
          <div class="badge ${roleBadgeCls(role)}" style="margin-bottom:8px">${roleLabel(role,state.lang)}</div>
          <p style="font-size:1.12rem">${desc}</p>
          <p class="muted" style="margin-top:10px;font-size:.9rem">${T[state.lang].rolesLegend}: ${T[state.lang].legendHTML}</p>
        </div>`;
        $('#nextPlayer').disabled=false;
        card.onclick=null; card.onkeydown=null;
      }
      card.onclick=reveal; card.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();reveal();}};
      card.onmousemove=e=>{const r=card.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width*2-1; const y=(e.clientY-r.top)/r.height*2-1; card.style.transform=`rotateX(${(-y*6).toFixed(2)}deg) rotateY(${(x*6).toFixed(2)}deg)`};
      card.onmouseleave=()=>{card.style.transform='rotateX(0) rotateY(0)'};

      $('#nextPlayer').onclick=()=>{
        if(!g.revealed){ return toast(T[state.lang].mustReveal); }
        g.index++; showNextRole();
      };
    }

    // Timer
    const fmt=s=>{const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`};
    function startTimer(){const g=state.game; if(!g) return; $('#timer').textContent=fmt(g.time); clearInterval(g.timer); g.timer=setInterval(()=>{g.time=Math.max(0,g.time-1); $('#timer').textContent=fmt(g.time); if(g.time<=0){clearInterval(g.timer); onTimeUp();}},1000)}
    function pauseTimer(){const g=state.game; if(!g) return; if(g.timer){clearInterval(g.timer); g.timer=null; $('#pauseTimer').innerHTML='‚ñ∂Ô∏è '+(state.lang==='it'?'Riprendi':'Resume');} else {startTimer(); $('#pauseTimer').innerHTML='‚è∏Ô∏è '+T[state.lang].pause;}}
    function onTimeUp(){toast(T[state.lang].timerUp); goVote();}

    // ‚ÄúLa prima domanda la fa: ‚Ä¶‚Äù
    function setFirstQuestion(){
      const g=state.game; if(!g) return;
      const pick=g.order[(Math.random()*g.order.length)|0];
      $('#firstQuestionHint').innerHTML = `La prima domanda la fa: <b>${pick}</b>`;
    }

    // Voting
    function goVote(){
      showView('view-vote');
      const g=state.game; g.votes={}; const ul=$('#voteList'); ul.innerHTML='';
      g.order.forEach(p=>{
        const li=document.createElement('li');
        li.innerHTML=`<span>${p}</span>
          <span class="row">
            <button class="btn secondary" data-vote="+">Vota</button>
            <span class="chip" data-count>üó≥Ô∏è 0</span>
            <button class="btn ghost" data-vote="-">‚àí</button>
          </span>`;
        const count=li.querySelector('[data-count]');
        const update=()=>{count.textContent='üó≥Ô∏è '+(g.votes[p]||0)}
        li.querySelector('[data-vote="+"]').onclick=()=>{g.votes[p]=(g.votes[p]||0)+1; update();};
        li.querySelector('[data-vote="-"]').onclick=()=>{g.votes[p]=Math.max(0,(g.votes[p]||0)-1); update();};
        ul.appendChild(li);
      });
    }

    function showResults(){
      const g=state.game; if(!g) return; showView('view-results');
      const entries=Object.entries(g.votes);
      const arr=entries.length?entries.sort((a,b)=>b[1]-a[1]):[];
      let html='';
      html+='<ul class="list">'+g.order.map(name=>{
        const c=g.votes[name]||0;
        return `<li><span>${name}</span><span class="chip">üó≥Ô∏è ${c}</span></li>`;
      }).join('')+'</ul>';

      if(arr.length===0 || (arr[0][1]||0)===0){
        html+=`<p class="muted" style="margin-top:10px">${state.lang==='it'?'Nessun voto espresso.':'No votes cast.'}</p>`;
        $('#resultsBox').innerHTML=html; return;
      }

      // gestisci ex-aequo
      const max=arr[0][1];
      const topTied=arr.filter(x=>x[1]===max).map(x=>x[0]);
      const chosen=topTied[(Math.random()*topTied.length)|0];

      const idx=g.order.indexOf(chosen);
      const role=g.roles[idx];
      html+=`<p style="margin-top:12px">${T[state.lang].eliminated(chosen,roleLabel(role,state.lang))}</p>`;
      const spyTeam=(role===Role.spy||role===Role.fake);
      html+=`<p class="chip" style="margin-top:10px; ${spyTeam?'background:var(--ok);color:#0d0f1a':'background:var(--danger);color:#fff'}">${spyTeam?'‚úÖ':'‚ùå'} ${spyTeam?T[state.lang].civsWin:T[state.lang].spiesWin}</p>`;
      $('#resultsBox').innerHTML=html;
      confetti(spyTeam?'civ':'spy');
    }

    let revealedListShown=false;
    function revealAll(){
      const g=state.game; if(!g || revealedListShown) return;
      const list=g.order.map((p,i)=>({name:p,role:g.roles[i]}));
      const rows=list.map(o=>`<li><span>${o.name}</span><span class="chip ${roleBadgeCls(o.role)}">${roleLabel(o.role,state.lang)}</span></li>`).join('');
      $('#resultsBox').innerHTML+=`<div style="margin-top:10px"><ul class="list">${rows}</ul></div>`;
      revealedListShown=true;
    }
    function restart(){state.game=null; revealedListShown=false; showView('view-home')}

    // Lang switch
    function loadCustomForLang(lang){ state.custom = LS.get('custom_'+lang,{}); }
    function switchLang(lang){ state.lang = lang; LS.set('lang',lang); loadCustomForLang(lang); i18nRefresh(); }

    // Nav + FX + Accordion
    function showView(id){$$('[data-view]').forEach(s=>s.classList.remove('show')); const el=document.getElementById(id); if(el){ el.classList.add('show'); revealOnScroll(); window.scrollTo({top:0,behavior:'smooth'}); }}
    function revealOnScroll(){const cards=$$('.card'); if(!('IntersectionObserver' in window)){cards.forEach(c=>c.classList.add('in')); return;} const io=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting) e.target.classList.add('in');});},{rootMargin:'0px 0px -10% 0px',threshold:.1}); cards.forEach(c=>io.observe(c));}
    function addRipples(){document.body.addEventListener('click',e=>{const b=e.target.closest('.btn'); if(!b) return; const r=b.getBoundingClientRect(); const d=document.createElement('span'); const size=Math.max(r.width,r.height); d.style.cssText=`position:absolute;left:${e.clientX-r.left-size/2}px;top:${e.clientY-r.top-size/2}px;width:${size}px;height:${size}px;border-radius:50%;background:rgba(255,255,255,.25);transform:scale(0);opacity:.7;pointer-events:none;transition:transform .4s ease,opacity .6s;`; b.appendChild(d); requestAnimationFrame(()=>d.style.transform='scale(1.6)'); setTimeout(()=>{d.style.opacity='0'; setTimeout(()=>d.remove(),300);},250);});}
    function toggleAcc(which){
      const body=$('#acc-'+which);
      body.classList.toggle('collapsed');
    }
    function scrollToSection(which){
      // espandi e scrolla alla sezione giusta
      const head=$(`[data-acc="${which}"]`); const body=$('#acc-'+which);
      if(body.classList.contains('collapsed')) body.classList.remove('collapsed');
      showView('view-home');
      setTimeout(()=> head?.scrollIntoView({behavior:'smooth',block:'start'}), 100);
    }

    // Confetti
    function confetti(type){const cvs=$('#fxConfetti'); const ctx=cvs.getContext('2d'); const W=cvs.width=innerWidth, H=cvs.height=innerHeight; const colors=type==='civ'?['#67e8f9','#60a5fa','#a78bfa','#ffffff']:['#ef476f','#ff9aa5','#ffd1d6','#ffffff']; const parts=Array.from({length:110},()=>({x:Math.random()*W,y:-20,vx:(Math.random()-.5)*2,vy:2+Math.random()*2,size:4+Math.random()*6,rot:Math.random()*360,color:colors[(Math.random()*colors.length)|0],life:60+Math.random()*60})); let anim; function frame(){ctx.clearRect(0,0,W,H); parts.forEach(p=>{p.x+=p.vx; p.y+=p.vy; p.vy+=.02; p.rot+=3; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();}); if(parts.some(p=>p.life>0 && p.y<H+20)) anim=requestAnimationFrame(frame); else cancelAnimationFrame(anim);} frame(); setTimeout(()=>ctx.clearRect(0,0,W,H),2500);}

    // PWA
    function registerPWA(){ if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{});} const link=document.createElement('link'); link.rel='manifest'; link.href='/manifest.webmanifest'; document.head.appendChild(link);}    

    // Events
    $('#themeBtn').onclick=cycleTheme; 
    $('#lang').onchange=e=>switchLang(e.target.value);
    $('#goStart').onclick=()=>showView('view-home'); $('#goHow').onclick=()=>$('#modalHelp').showModal();
    $('#homeBtn').onclick=()=>showView('view-landing');
    $('#titleBtn').onclick=()=>showView('view-landing');

    // Accordion heads
    $$('[data-acc]').forEach(h=> h.addEventListener('click',()=> toggleAcc(h.getAttribute('data-acc'))));

    $('#addPlayer').onclick=addPlayer; $('#playerInput').addEventListener('keydown',e=>{if(e.key==='Enter') addPlayer();});
    $('#shufflePlayers').onclick=()=>{state.players.sort(()=>Math.random()-.5); savePlayers(); renderPlayers();};
    $('#clearPlayers').onclick=()=>{ modalInfo(`<p>${state.lang==='it'?'Svuotare la lista giocatori?':'Clear players list?'}</p>`,[
      {label: state.lang==='it'?'Annulla':'Cancel', kind:'ghost'},
      {label: state.lang==='it'?'Svuota':'Clear', kind:'danger', onClick:()=>{ state.players=[]; savePlayers(); renderPlayers(); }}
    ]); };

    $('#categorySelect').onchange=e=>{state.category=e.target.value; LS.set('category',state.category); updateSelectedCatView();};
    $('#openCats').onclick=()=>showView('view-cats'); $('#saveCategory').onclick=saveNewCategory; $('#backHomeFromCats').onclick=()=>showView('view-home');
    $$('[data-step]').forEach(btn=> btn.onclick=()=>{const id=btn.getAttribute('data-step'); const delta=Number(btn.getAttribute('data-delta')); const el=document.getElementById(id); el.value=clamp(Number(el.value)+delta, Number(el.min), Number(el.max)); renderSummaryPill();});
    $('#saveSettings').onclick=saveSettings;
    $('#helpBtn').onclick=()=>$('#modalHelp').showModal(); $('#closeHelp').onclick=()=>$('#modalHelp').close(); $('#modalClose').onclick=()=>$('#modal').close();
    $('#startGameMain').onclick=startGame; $('#howToBtn').onclick=()=>$('#modalHelp').showModal(); $('#pauseTimer').onclick=pauseTimer; $('#endRound').onclick=()=>onTimeUp(); $('#seeResults').onclick=showResults; $('#revealAll').onclick=revealAll; $('#restart').onclick=restart;

    // Init
    (function init(){
      setTimeout(()=>$('#splash').classList.add('hide'), 600);
      $('#themeBtn').textContent=state.theme==='auto'?'üåì':state.theme==='light'?'‚òÄÔ∏è':'üåô';
      applyTheme(); loadCustomForLang(state.lang); $('#lang').value=state.lang; writeSettings(state.settings);
      i18nRefresh(); addRipples(); showView('view-landing'); registerPWA();
      // Default: giocatori e impostazioni aperti, categorie aperte
      ['players','cats','settings'].forEach(k=>$('#acc-'+k).classList.remove('collapsed'));
    })();
  </script>

  <!--
    ====== PWA files da aggiungere alla root del sito ======
    1) /manifest.webmanifest
    2) /sw.js
    3) /icons/icon-192.png, /icons/icon-512.png, /icons/maskable-512.png (usa le tue icone brand)

    --- manifest.webmanifest ---
    {
      "name": "Gioco Spia",
      "short_name": "Spia",
      "description": "Party game mobile con Spia, Finta Spia, Avvocato.",
      "start_url": "/index.html",
      "scope": "/",
      "display": "standalone",
      "background_color": "#0d0f1a",
      "theme_color": "#0d0f1a",
      "icons": [
        { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
        { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" },
        { "src": "/icons/maskable-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
      ]
    }

    --- sw.js ---
    const CACHE_NAME='spia-v1';
    const ASSETS=['/','/index.html'];
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()))});
    self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k))))); self.clients.claim()});
    self.addEventListener('fetch',e=>{const req=e.request; e.respondWith(caches.match(req).then(res=>res||fetch(req).then(r=>{const copy=r.clone(); caches.open(CACHE_NAME).then(c=>c.put(req,copy)); return r;}).catch(()=>caches.match('/index.html'))))});
  -->
</body>
</html>
