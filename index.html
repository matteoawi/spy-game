<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0f1a" id="metaTheme" />
  <title>Gioco Spia â€” Edizione Pro</title>
  <meta name="description" content="Party game mobile. Ruoli: Spia, Finta Spia, Avvocato, Civile. Timer, votazioni multi-turno, categorie personalizzate. PWA." />

  <style>
    /* ====== Reset & Tokens ====== */
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --bg:#0d0f1a; --surface:#111425; --surface-2:#0b1020; --line:rgba(255,255,255,.08);
      --fg:#e8edf7; --muted:#a9b2c7; --primary:#60a5fa; --accent:#67e8f9; --ok:#34d399; --danger:#ef476f;
      --shadow:0 10px 30px rgba(0,0,0,.45); --ring:0 0 0 3px rgba(96,165,250,.35);
      --r-lg:22px; --r-md:14px; --r-sm:10px; --space:clamp(14px,3.4vw,22px);
      --content:min(100vw - 2*var(--space), 880px);
      /* Colori ruoli */
      --c-spy:#ef476f;   --c-fake:#f59e0b;  --c-law:#34d399;  --c-civ:#60a5fa;
    }
    [data-theme="light"]:root{
      --bg:#f8fafc; --surface:#ffffff; --surface-2:#eef2ff; --line:rgba(13,15,26,.08);
      --fg:#0d1224; --muted:#64748b; --primary:#2563eb; --accent:#06b6d4; --ok:#16a34a; --danger:#dc2626;
      --shadow:0 8px 28px rgba(2,6,23,.08); --ring:0 0 0 3px rgba(37,99,235,.22);
      --c-spy:#dc2626; --c-fake:#d97706; --c-law:#16a34a; --c-civ:#2563eb;
    }
    html,body{height:100%}
    body{margin:0;color:var(--fg);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.4;-webkit-font-smoothing:antialiased}

    /* Background FX */
    .bg{position:fixed;inset:0;pointer-events:none;z-index:-2;
      background:
        radial-gradient(800px 420px at 120% -10%, rgba(103,232,249,.12), transparent 60%),
        radial-gradient(700px 400px at -20% 110%, rgba(96,165,250,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--surface-2) 35%, var(--bg) 85%);
    }
    .grain{position:fixed;inset:0;pointer-events:none;z-index:-1;opacity:.2;mix-blend-mode:soft-light;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 40 40"><g fill="%23ffffff" fill-opacity="0.03"><circle cx="2" cy="2" r="1"/><circle cx="6" cy="18" r="1"/><circle cx="14" cy="6" r="1"/><circle cx="22" cy="30" r="1"/><circle cx="36" cy="12" r="1"/></g></svg>');
    }

    /* Header */
    header{position:relative;z-index:20;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px);
      background:color-mix(in oklab, var(--surface), transparent 28%);
    }
    .bar{max-width:var(--content);margin:0 auto;padding:10px var(--space);display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:nowrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:0;cursor:pointer}
    .brand .logo{flex:0 0 auto;width:36px;height:36px;border-radius:12px;display:grid;place-items:center;font-size:22px;background:transparent;box-shadow:none}
    #appTitle{font-size:18px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px;flex:0 0 auto}
    .controls select{min-width:74px}

    /* Splash (sparisce davvero) */
    .splash{position:fixed;inset:0;display:grid;place-items:center;z-index:100;background:radial-gradient(1200px 600px at 50% -10%,color-mix(in srgb,var(--primary),transparent 68%),transparent),var(--bg);transition:opacity .6s ease, visibility .6s ease}
    .splash.hide{opacity:0;visibility:hidden;pointer-events:none}

    /* Layout */
    .wrap{max-width:var(--content);margin:0 auto;padding:calc(var(--space) + env(safe-area-inset-top)) var(--space) calc(96px + env(safe-area-inset-bottom));}

    /* Controls */
    select,input[type=text],input[type=number],textarea{width:100%;padding:14px;background:var(--surface-2);color:var(--fg);border:1px solid var(--line);border-radius:var(--r-md);font-size:16px;outline:none}
    input::placeholder, textarea::placeholder{opacity:.7}
    select:focus,input:focus,textarea:focus{box-shadow:var(--ring);border-color:color-mix(in srgb,var(--primary),transparent 50%)}
    .btn{appearance:none;-webkit-tap-highlight-color:transparent;cursor:pointer;border:none;border-radius:999px;padding:12px 16px;font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow);background:var(--primary);color:#0d0f1a;position:relative;overflow:hidden}
    .btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--line);box-shadow:none}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.ok{background:var(--ok);color:#0d0f1a}
    .btn.secondary{background:color-mix(in srgb,var(--primary),var(--accent) 40%)}

    /* Cards */
    .card{background:linear-gradient(180deg,var(--surface),var(--surface-2));border:1px solid var(--line);border-radius:var(--r-lg);padding:18px;box-shadow:var(--shadow);transform:translateY(6px) scale(.985);opacity:0;transition:transform .5s cubic-bezier(.2,.7,.2,1),opacity .5s}
    .card.in{transform:translateY(0) scale(1);opacity:1}
    .section-title{display:flex;align-items:center;gap:8px;margin:0 0 8px}

    /* Collapsible (partono nascosti) */
    [data-collapsible] .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    [data-collapsible] .card-body{overflow:hidden;max-height:0;transition:max-height .35s ease}
    [data-collapsible].open .card-body{max-height:1000px} /* grow animato */
    /* Riassunto impostazioni visibile sempre */
    #settingsSummary{display:inline-flex;gap:8px;align-items:center}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .list li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:var(--surface-2);border:1px solid var(--line);border-radius:14px}

    /* Role card */
    .role-card{display:grid;place-items:center;min-height:320px;border-radius:var(--r-lg);background:var(--surface-2);border:1px dashed var(--line);user-select:none;transform-style:preserve-3d;transition:transform .12s ease;padding:24px}
    .role-card.revealed{border-style:solid}
    .role-name{font-size:1.35rem;font-weight:900}
    .role-word,.role-strong{font-weight:900}

    /* Badges ruoli */
    .badge{display:inline-flex;align-items:center;font-weight:800;padding:6px 10px;border-radius:999px}
    .b-spy{background:var(--c-spy);color:#fff}
    .b-fake{background:var(--c-fake);color:#0d0f1a}
    .b-law{background:var(--c-law);color:#0d0f1a}
    .b-civ{background:var(--c-civ);color:#0d0f1a}

    /* Timer */
    .timer{font-variant-numeric:tabular-nums;font-weight:900;font-size:clamp(42px,14vw,86px);line-height:1}

    /* Views */
    [data-view]{display:none}
    [data-view].show{display:block}

    /* FX */
    #fxConfetti{position:fixed;inset:0;pointer-events:none;z-index:50}

    footer{opacity:.85;padding:18px;text-align:center;font-size:.92rem}

    /* Mobile header: tutto su una riga */
    @media (max-width:480px){
      .controls select{min-width:64px}
      .btn{padding:12px 14px}
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <!-- Splash -->
  <div class="splash" id="splash" aria-hidden="true">
    <div class="card in" style="text-align:center;max-width:320px">
      <div class="logo" style="width:64px;height:64px;margin-inline:auto;font-size:42px">ğŸ•µï¸â€â™‚ï¸</div>
      <h2 style="margin:8px 0 4px">Gioco Spia</h2>
      <p class="muted" style="margin:0">Ready â€¢ Set â€¢ Suspect</p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="bar">
      <div class="brand" id="titleBtn" title="Vai alla home">
        <div class="logo" aria-hidden="true">ğŸ•µï¸â€â™‚ï¸</div>
        <h1 id="appTitle">Gioco Spia</h1>
      </div>
      <div class="controls">
        <button id="themeBtn" class="btn ghost" title="Tema">ğŸŒ“</button>
        <select id="lang" aria-label="Lingua">
          <option value="it">ğŸ‡®ğŸ‡¹ IT</option>
          <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
        </select>
        <button id="helpBtn" class="btn ghost" title="Regole">â“</button>
      </div>
    </div>
  </header>

  <canvas id="fxConfetti"></canvas>

  <main class="wrap">
    <!-- Landing -->
    <section data-view id="view-landing" class="show">
      <div class="card in hero" style="text-align:center">
        <h2 id="heroTitle">Il party game in tasca</h2>
        <p id="heroDesc">Spie, Finte Spie e Avvocati. UI moderna, salvataggio locale, nessun account.</p>
        <div class="row" style="justify-content:center">
          <button id="goStart" class="btn secondary">ğŸš€ <span data-i="startNow">Inizia</span></button>
          <button id="goHow" class="btn ghost">ğŸ“œ <span data-i="rules">Istruzioni</span></button>
        </div>
      </div>

      <!-- Counters & storico -->
      <div class="card in" id="statsCard" style="cursor:pointer">
        <h3 class="section-title">ğŸ“ˆ Andamento partite</h3>
        <div class="row" id="statsRow" style="flex-wrap:wrap">
          <span class="badge" style="background:var(--surface-2);border:1px solid var(--line)">ğŸ® <b id="s_games">0</b> partite</span>
          <span class="badge b-civ">ğŸ‘¤ Civili <b id="s_civ">0%</b></span>
          <span class="badge b-spy">ğŸ•µï¸ Spie <b id="s_spy">0%</b></span>
          <span class="badge b-fake">ğŸ­ Finte Spie <b id="s_fake">0%</b></span>
          <span class="badge b-law">âš–ï¸ Avvocati <b id="s_law">0%</b></span>
        </div>
        <p class="muted" style="margin-top:6px">Tocca per aprire lo <b>storico</b> delle partite.</p>
      </div>

      <div class="card">
        <h3 class="section-title">ğŸ§  Ruoli speciali</h3>
        <p class="muted">Spia, Finta Spia, Avvocato, Civile. Votazione a turni (una per Spia), timer con suono, categorie personalizzate.</p>
        <p class="muted">ğŸ’¾ Salvataggio <b>automatico</b>: giocatori, impostazioni, categorie e storico restano nel tuo browser.</p>
      </div>
    </section>

    <!-- Home / Setup -->
    <section data-view id="view-home">
      <!-- Giocatori -->
      <div class="card" id="card-players" data-collapsible>
        <div class="card-head">
          <h2 class="section-title">ğŸ‘¥ <span data-i="players">Giocatori</span> (<span id="playersCount">0</span>)</h2>
          <button class="btn ghost" data-toggle>â–¾</button>
        </div>
        <div class="card-body">
          <div class="row">
            <input id="playerInput" class="grow" type="text" maxlength="24" placeholder="Nome giocatore" />
            <button id="addPlayer" class="btn" aria-label="Aggiungi giocatore">â• Aggiungi giocatore</button>
          </div>
          <ul id="playersList" class="list" aria-label="Lista giocatori"></ul>
          <div class="row">
            <button id="shufflePlayers" class="btn ghost">ğŸ”€ <span data-i="shuffle">Mescola</span></button>
            <button id="clearPlayers" class="btn danger">ğŸ—‘ï¸ <span data-i="clear">Svuota</span></button>
          </div>
          <p class="muted" style="margin-top:6px">ğŸ’¾ Salvataggio automatico dei nomi.</p>
        </div>
      </div>

      <!-- Categorie -->
      <div class="card" id="card-categories" data-collapsible>
        <div class="card-head">
          <h2 class="section-title">ğŸ“š <span data-i="categories">Categorie</span></h2>
          <button class="btn ghost" data-toggle>â–¾</button>
        </div>
        <div class="card-body">
          <div class="row">
            <select id="categorySelect" class="grow" aria-label="Categoria"></select>
            <button id="openCats" class="btn ghost">ğŸ”§ <span data-i="manage">Gestisci</span></button>
          </div>
          <p class="muted" id="selectedCategoryView">ğŸ“Œ <span data-i="selectedCat">Categoria selezionata</span>: <strong id="selCatTxt">â€”</strong></p>
        </div>
      </div>

      <!-- Impostazioni -->
      <div class="card" id="card-settings" data-collapsible>
        <div class="card-head">
          <h2 class="section-title">âš™ï¸ <span data-i="gameSettings">Impostazioni</span></h2>
          <!-- Riassunto sempre fuori -->
          <span id="settingsSummary" class="chip" aria-live="polite"></span>
          <button class="btn ghost" data-toggle>â–¾</button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="grow">
              <label for="numSpies">ğŸ•µï¸ Spie</label>
              <div class="row">
                <input id="numSpies" type="number" min="1" max="6" step="1" value="1" />
                <button class="btn ghost" data-step="numSpies" data-delta="-1">â€“</button>
                <button class="btn ghost" data-step="numSpies" data-delta="1">+</button>
              </div>
            </div>
            <div class="grow">
              <label for="numFakeSpies">ğŸ­ Finte spie</label>
              <div class="row">
                <input id="numFakeSpies" type="number" min="0" max="6" step="1" value="0" />
                <button class="btn ghost" data-step="numFakeSpies" data-delta="-1">â€“</button>
                <button class="btn ghost" data-step="numFakeSpies" data-delta="1">+</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label for="numLawyers">âš–ï¸ Avvocati</label>
              <div class="row">
                <input id="numLawyers" type="number" min="0" max="6" step="1" value="0" />
                <button class="btn ghost" data-step="numLawyers" data-delta="-1">â€“</button>
                <button class="btn ghost" data-step="numLawyers" data-delta="1">+</button>
              </div>
            </div>
            <div class="grow">
              <label for="roundMinutes">â±ï¸ Minuti</label>
              <div class="row">
                <input id="roundMinutes" type="number" min="1" max="99" step="1" value="5" />
                <button class="btn ghost" data-step="roundMinutes" data-delta="-1">â€“</button>
                <button class="btn ghost" data-step="roundMinutes" data-delta="1">+</button>
              </div>
            </div>
          </div>

          <div class="row">
            <label class="chip"><input type="checkbox" id="optElimNoVote" /> ğŸš« Gli eliminati non votano piÃ¹</label>
            <label class="chip"><input type="checkbox" id="optSpiesKnow" /> ğŸ•µï¸â€â¡ï¸ Le spie si conoscono (tra loro, non le Finte)</label>
          </div>

          <p class="muted">ğŸ’¡ I ruoli speciali totali devono essere <b>minori</b> dei giocatori.</p>
          <div class="row">
            <button id="saveSettings" class="btn ok">ğŸ’¾ Salva</button>
          </div>
        </div>
      </div>

      <!-- Avvio -->
      <div class="card">
        <h2 class="section-title">ğŸš€ Avvia partita</h2>
        <p class="muted">Serve almeno 1 Spia, 3 giocatori e una categoria con parole.</p>
        <div class="row">
          <button id="startGameMain" class="btn secondary">â–¶ï¸ Inizia ora</button>
          <button id="howToBtn" class="btn ghost">ğŸ“œ Regole</button>
        </div>
      </div>
    </section>

    <!-- Gestione categorie -->
    <section data-view id="view-cats">
      <div class="card"><h2 class="section-title">ğŸ“š Gestisci categorie</h2>
        <div class="row"><button id="backHomeFromCats" class="btn ghost">â† Indietro</button></div>
      </div>
      <div class="card"><h3 class="section-title">ğŸ§© Le tue categorie</h3>
        <ul id="customCatsList" class="list"></ul>
      </div>
      <div class="card">
        <h3 class="section-title">â• Nuova categoria</h3>
        <div class="row"><input id="catName" class="grow" type="text" placeholder="Nome categoria (es. Film)" /></div>
        <div class="row"><textarea id="catWords" rows="3" placeholder="Parole separate da virgola o a capo"></textarea></div>
        <div class="row"><button id="saveCategory" class="btn ok">ğŸ’¾ Salva</button></div>
        <p class="muted" style="margin-top:6px">ğŸ’¾ Salvataggio automatico per lingua.</p>
      </div>
      <div class="card"><h3 class="section-title">ğŸ“¦ Categorie predefinite</h3>
        <ul id="stockCatsList" class="list"></ul>
      </div>
    </section>

    <!-- Ruoli -->
    <section data-view id="view-roles">
      <div class="card">
        <h2 class="section-title">ğŸªª Assegnazione ruoli</h2>
        <p class="muted">Nome del giocatore: <span id="currentPlayer" class="role-name"></span></p>

        <!-- Legenda ruoli fuori dalla card -->
        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <span class="badge b-spy">ğŸ•µï¸ Spia</span>
          <span class="badge b-fake">ğŸ­ Finta Spia</span>
          <span class="badge b-law">âš–ï¸ Avvocato</span>
          <span class="badge b-civ">ğŸ‘¤ Civile</span>
        </div>

        <div class="role-card" id="roleCard" tabindex="0" aria-live="polite" aria-label="Carta ruolo">
          <span class="muted">Tocca o premi Invio per vedere il tuo ruolo</span>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="nextPlayer" class="btn secondary" disabled>â¡ï¸ Prossimo</button>
        </div>
      </div>
    </section>

    <!-- Gioco -->
    <section data-view id="view-game">
      <div class="card" style="text-align:center">
        <h2 class="section-title" style="justify-content:center">ğŸ® Gioco in corso</h2>
        <p id="firstQuestionHint" class="muted" style="margin-top:0"></p>
        <div class="timer" id="timer">05:00</div>
        <div class="row" style="justify-content:center;gap:10px;margin-top:8px">
          <button id="pauseTimer" class="btn ghost">â¸ï¸ Pausa</button>
          <button id="endRound" class="btn danger">â° Termina round</button>
        </div>
      </div>
    </section>

    <!-- Voto -->
    <section data-view id="view-vote">
      <div class="card">
        <h2 class="section-title" id="voteTitle">ğŸ—³ï¸ Votate la spia 1/1</h2>
        <p class="muted" id="voteHint">Tocca â€œVotaâ€ accanto a un nome per assegnargli un voto. In caso di paritÃ  dovete prendere una decisione!<br><small id="voteSubHint"></small></p>
        <ul id="voteList" class="list" aria-label="Votazione"></ul>
        <div class="row">
          <button id="seeRoundResult" class="btn secondary">ğŸ“Š Chi eliminiamo</button>
        </div>
      </div>
    </section>

    <!-- Risultati -->
    <section data-view id="view-results">
      <div class="card">
        <h2 class="section-title">ğŸ“ˆ Esito</h2>
        <div id="resultsBox"></div>
        <div class="row" style="margin-top:12px">
          <button id="revealAll" class="btn ghost">ğŸƒ Rivela tutti i ruoli</button>
          <button id="restart" class="btn ok">ğŸ”„ Gioca di nuovo</button>
        </div>
      </div>
    </section>

    <!-- Storico -->
    <section data-view id="view-history">
      <div class="card">
        <h2 class="section-title">ğŸ—‚ï¸ Storico partite</h2>
        <div id="historyList"></div>
        <div class="row" style="margin-top:8px">
          <button id="clearHistory" class="btn danger">ğŸ—‘ï¸ Svuota storico</button>
          <button id="backFromHistory" class="btn ghost">â† Indietro</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="wrap">
    <span style="font-size:.9rem">Â© 2025 â€¢ Dati <b>locali</b> nel tuo browser.</span>
  </footer>

  <!-- Modale generica (niente alert di sistema) -->
  <dialog id="modal" aria-live="polite">
    <div class="modal-head"><strong id="modalTitle">Info</strong><button class="btn ghost" id="modalClose" aria-label="Chiudi">âœ•</button></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions" id="modalActions" style="display:flex;gap:10px;justify-content:flex-end;padding:0 18px 16px"></div>
  </dialog>

  <!-- Audio fine timer -->
  <audio id="beep" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
    <!-- usa un tuo suono se preferisci -->
  </audio>

  <script>
  "use strict";

  /* ====== Helpers & State ====== */
  const LS={get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):(f??null)}catch{return f??null}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}},del:k=>{try{localStorage.removeItem(k)}catch{}}};
  const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];

  const Role={spy:"spy",fake:"fake",law:"law",civ:"civ"};
  const roleBadgeCls=r=> r===Role.spy?'b-spy':r===Role.fake?'b-fake':r===Role.law?'b-law':'b-civ';
  const roleLabel=r=> (r===Role.spy?'Spia':r===Role.fake?'Finta Spia':r===Role.law?'Avvocato':'Civile');

  const STOCK={
    it:{"Animali":["Cane","Gatto","Elefante","Leone","Tigre","Giraffa","Zebra","Scimmia","Orso","Lupo","Volpe","Pinguino","Delfino","Aquila","Gufo"],"Cibo":["Pizza","Pasta","Gelato","Sushi","Hamburger","Lasagna","Risotto","TiramisÃ¹","Cioccolato","Formaggio"],"Sport":["Calcio","Basket","Nuoto","Tennis","Rugby","Volley","Ciclismo","Atletica","Sci","Pattinaggio"],"Luoghi":["Bar","Ospedale","Scuola","Parco","Museo","Biblioteca","Cinema","Ristorante","Aeroporto","Stadio"],"Professioni":["Medico","Ingegnere","Avvocato","Insegnante","Poliziotto","Pompiere","Architetto","Cuoco","Pilota","Musicista"]},
    en:{"Animals":["Dog","Cat","Elephant","Lion","Tiger","Giraffe","Zebra","Monkey","Bear","Wolf","Fox","Penguin","Dolphin","Eagle","Owl"],"Food":["Pizza","Pasta","Ice Cream","Sushi","Hamburger","Lasagna","Risotto","Tiramisu","Chocolate","Cheese"],"Sports":["Football","Basketball","Swimming","Tennis","Rugby","Volleyball","Cycling","Athletics","Skiing","Skating"],"Places":["Bar","Hospital","School","Park","Museum","Library","Cinema","Restaurant","Airport","Stadium"],"Professions":["Doctor","Engineer","Lawyer","Teacher","Police Officer","Firefighter","Architect","Cook","Pilot","Musician"]}
  };

  const state={
    theme: LS.get('theme','auto'),
    lang:  LS.get('lang','it'),
    players: LS.get('players',[]),
    custom:  LS.get('custom_'+(LS.get('lang','it')||'it'),{}),
    category: LS.get('category',''),
    settings: LS.get('settings',{spies:1,fakes:0,laws:0,minutes:5,optElimNoVote:false,optSpiesKnow:false}),
    history: LS.get('history',[]),
    game: null
  };

  /* ====== Theme ====== */
  function metaThemeSync(){const meta=document.getElementById('metaTheme');meta.content=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();}
  function applyTheme(){const root=document.documentElement; if(state.theme==='auto'){const dark=matchMedia('(prefers-color-scheme: dark)').matches; root.setAttribute('data-theme',dark?'dark':'light');} else root.setAttribute('data-theme',state.theme); metaThemeSync();}
  function cycleTheme(){state.theme=state.theme==='auto'?'light':state.theme==='light'?'dark':'auto'; LS.set('theme',state.theme); document.getElementById('themeBtn').textContent=state.theme==='auto'?'ğŸŒ“':state.theme==='light'?'â˜€ï¸':'ğŸŒ™'; applyTheme();}
  matchMedia('(prefers-color-scheme: dark)').addEventListener?.('change',()=>{if(state.theme==='auto') applyTheme();});

  /* ====== Modal (no alert di sistema) ====== */
  function modal(html,{title='',actions=[]}={}){
    const d=$('#modal'); if(!d||!d.showModal) return;
    $('#modalTitle').textContent=title;
    $('#modalBody').innerHTML=html;
    const act=$('#modalActions'); act.innerHTML='';
    actions.forEach(a=>{
      const b=document.createElement('button'); b.className='btn '+(a.kind||'secondary'); b.textContent=a.label;
      b.onclick=()=>{a.onClick?.(); d.close();};
      act.appendChild(b);
    });
    d.showModal();
  }
  $('#modalClose').onclick=()=>$('#modal').close();

  /* ====== i18n basica (IT/EN) ====== */
  function i18nRefresh(){
    $('#appTitle').textContent = state.lang==='it'?'Gioco Spia':'Spy Game';
    $('#heroTitle').textContent = state.lang==='it'?'Il party game in tasca':'The party game in your pocket';
    $('#heroDesc').textContent  = state.lang==='it'?'Spie, Finte Spie e Avvocati. UI moderna, salvataggio locale, nessun account.':'Spies, Fake Spies and Lawyers. Modern UI, local save, no account.';
    $('#playerInput').placeholder = state.lang==='it'?'Nome giocatore':'Player name';
    $('#catName').placeholder = state.lang==='it'?'Nome categoria (es. Film)':'Category name (e.g., Movies)';
    $('#catWords').placeholder = state.lang==='it'?'Parole separate da virgola o a capo':'Words separated by comma or newline';
    $('#lang').value = state.lang;
    renderCategories(); updateSelectedCat(); renderPlayers(); renderCatsPage(); renderStats();
    renderSettingsSummary();
  }

  /* ====== Splash out ====== */
  setTimeout(()=>{ const s=$('#splash'); s?.classList.add('hide'); setTimeout(()=>s?.remove(),650); }, 650);

  /* ====== Nav helpers ====== */
  function showView(id){
    // stop timer when leaving game
    if(state.game?.timer){clearInterval(state.game.timer); state.game.timer=null;}
    $$('[data-view]').forEach(s=>s.classList.remove('show'));
    document.getElementById(id)?.classList.add('show');
    window.scrollTo({top:0,behavior:'smooth'});
  }
  $('#titleBtn').onclick=()=>showView('view-landing');

  /* ====== Cards appear on scroll ====== */
  function revealOnScroll(){
    const cards=$$('.card'); if(!('IntersectionObserver' in window)){cards.forEach(c=>c.classList.add('in')); return;}
    const io=new IntersectionObserver(es=>es.forEach(e=>{if(e.isIntersecting)e.target.classList.add('in');}),{rootMargin:'0px 0px -10% 0px',threshold:.1});
    cards.forEach(c=>io.observe(c));
  }
  revealOnScroll();

  /* ====== Collapsible ====== */
  $$('[data-collapsible]').forEach(card=>{
    const btn=card.querySelector('[data-toggle]');
    btn.addEventListener('click',()=>{card.classList.toggle('open')});
  });

  /* ====== Players ====== */
  function renderPlayers(){
    const ul=$('#playersList'); ul.innerHTML='';
    state.players.forEach((p,idx)=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${p}</span>
      <span class="row">
        <button class="btn ghost" data-move="-1" title="Su">â¬†ï¸</button>
        <button class="btn ghost" data-move="1" title="GiÃ¹">â¬‡ï¸</button>
        <button class="btn danger" title="Rimuovi">âœ•</button>
      </span>`;
      li.querySelector('[data-move="-1"]').onclick=()=>{ if(idx>0){ [state.players[idx-1],state.players[idx]]=[state.players[idx],state.players[idx-1]]; savePlayers(); renderPlayers(); } };
      li.querySelector('[data-move="1"]').onclick=()=>{ if(idx<state.players.length-1){ [state.players[idx+1],state.players[idx]]=[state.players[idx],state.players[idx+1]]; savePlayers(); renderPlayers(); } };
      li.querySelector('.btn.danger').onclick=()=>{ state.players.splice(idx,1); savePlayers(); renderPlayers(); };
      ul.appendChild(li);
    });
    $('#playersCount').textContent=state.players.length;
  }
  function addPlayer(){ const v=$('#playerInput').value.trim(); if(!v) return; if(state.players.includes(v)){ $('#playerInput').value=''; return; } state.players.push(v); $('#playerInput').value=''; savePlayers(); renderPlayers(); }
  function savePlayers(){ LS.set('players',state.players); }

  $('#addPlayer').onclick=addPlayer;
  $('#playerInput').addEventListener('keydown',e=>{ if(e.key==='Enter') addPlayer(); });
  $('#shufflePlayers').onclick=()=>{ state.players.sort(()=>Math.random()-.5); savePlayers(); renderPlayers(); };
  $('#clearPlayers').onclick=()=> modal(`Svuotare la lista giocatori?`,{title:'Conferma',actions:[
    {label:'Annulla',kind:'ghost'},
    {label:'Svuota',kind:'danger',onClick:()=>{state.players=[]; savePlayers(); renderPlayers();}}
  ]});

  /* ====== Categories ====== */
  function allCategories(){ return {...STOCK[state.lang], ...(state.custom||{})} }
  function renderCategories(){
    const sel=$('#categorySelect'); sel.innerHTML='';
    const ph=document.createElement('option'); ph.disabled=true; ph.selected=!state.category; ph.textContent=state.lang==='it'?'Seleziona una categoria':'Select a category'; sel.appendChild(ph);
    const cats=allCategories(); Object.keys(cats).sort().forEach(cat=>{
      const o=document.createElement('option'); o.value=cat; o.textContent=`${cat} (${cats[cat].length} parole)`; if(cat===state.category) o.selected=true; sel.appendChild(o);
    });
  }
  function updateSelectedCat(){ $('#selCatTxt').textContent=state.category||'â€”'; }
  $('#categorySelect').onchange=e=>{ state.category=e.target.value; LS.set('category',state.category); updateSelectedCat(); };

  function renderCatsPage(){
    const customUl=$('#customCatsList'); const stockUl=$('#stockCatsList');
    customUl.innerHTML=''; stockUl.innerHTML='';
    const custom=state.custom||{}; const stock=STOCK[state.lang];
    Object.keys(custom).sort().forEach(cat=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${cat} <span class="muted">(${custom[cat].length})</span></span>
        <span class="row"><button class="btn ghost" data-edit>âœï¸</button><button class="btn danger" data-del>âœ•</button></span>`;
      li.querySelector('[data-edit]').onclick=()=>openEditor(cat, li);
      li.querySelector('[data-del]').onclick=()=> modal(`Eliminare la categoria "<b>${cat}</b>"?`,{title:'Conferma',actions:[
        {label:'Annulla',kind:'ghost'},
        {label:'Elimina',kind:'danger',onClick:()=>{ delete custom[cat]; state.custom=custom; LS.set('custom_'+state.lang,custom); if(state.category===cat) state.category=''; renderCategories(); renderCatsPage(); updateSelectedCat(); }}
      ]});
      customUl.appendChild(li);
    });
    Object.keys(stock).sort().forEach(cat=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${cat} <span class="muted">(${stock[cat].length})</span></span><span class="chip">Predefinita</span>`; stockUl.appendChild(li);
    });
  }
  function parseWords(txt){ return [...new Set(txt.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean))] }
  function saveNewCategory(){
    const name=$('#catName').value.trim(); if(!name) return modal('Inserisci un nome categoria.');
    const words=parseWords($('#catWords').value); if(words.length===0) return modal('Aggiungi almeno una parola.');
    if(!state.custom) state.custom={};
    state.custom[name]=[...(state.custom[name]||[]), ...words].filter((w,i,a)=>a.indexOf(w)===i);
    LS.set('custom_'+state.lang,state.custom);
    $('#catName').value=''; $('#catWords').value='';
    renderCategories(); renderCatsPage(); modal('Categoria salvata!');
  }
  $('#openCats').onclick=()=>showView('view-cats');
  $('#backHomeFromCats').onclick=()=>showView('view-home');
  $('#saveCategory').onclick=saveNewCategory;
  function openEditor(cat, li){
    [...$('#customCatsList').children].forEach(x=>x.classList.remove('editing'));
    li.classList.add('editing');
    const box=document.createElement('div'); box.style.marginTop='10px';
    box.innerHTML=`<div class="row"><input id="wInput" class="grow" type="text" placeholder="Aggiungi parola e premi Invio"/></div><div id="wChips" class="row" style="flex-wrap:wrap;gap:8px;margin-top:8px"></div>`;
    li.appendChild(box);
    const chips=box.querySelector('#wChips');
    function draw(){
      chips.innerHTML='';
      (state.custom[cat]||[]).forEach((w,i)=>{
        const c=document.createElement('span'); c.className='chip'; c.innerHTML=`${w} <button class="btn danger" style="padding:4px 8px">Ã—</button>`;
        c.querySelector('button').onclick=()=>{ state.custom[cat].splice(i,1); LS.set('custom_'+state.lang,state.custom); draw(); renderCategories(); };
        chips.appendChild(c);
      });
    }
    draw();
    box.querySelector('#wInput').addEventListener('keydown',e=>{
      if(e.key==='Enter'){ const v=e.target.value.trim(); if(!v) return;
        if(!state.custom[cat]) state.custom[cat]=[];
        if(!state.custom[cat].includes(v)) state.custom[cat].push(v);
        e.target.value=''; LS.set('custom_'+state.lang,state.custom); draw(); renderCategories();
      }
    });
  }

  /* ====== Settings ====== */
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,Number(n||0)));
  function readSettings(){
    return {
      spies: clamp($('#numSpies').value,1,6),
      fakes: clamp($('#numFakeSpies').value,0,6),
      laws:  clamp($('#numLawyers').value,0,6),
      minutes: clamp($('#roundMinutes').value,1,99),
      optElimNoVote: $('#optElimNoVote').checked,
      optSpiesKnow:  $('#optSpiesKnow').checked
    };
  }
  function writeSettings(s){
    $('#numSpies').value=s.spies; $('#numFakeSpies').value=s.fakes; $('#numLawyers').value=s.laws; $('#roundMinutes').value=s.minutes;
    $('#optElimNoVote').checked=s.optElimNoVote; $('#optSpiesKnow').checked=s.optSpiesKnow;
    renderSettingsSummary();
  }
  function saveSettings(){ state.settings=readSettings(); LS.set('settings',state.settings); modal('Impostazioni salvate!'); renderSettingsSummary(); }
  $('#saveSettings').onclick=saveSettings;
  $$('[data-step]').forEach(b=> b.onclick=()=>{ const id=b.getAttribute('data-step'); const delta=Number(b.getAttribute('data-delta')); const el=document.getElementById(id); el.value=clamp(Number(el.value)+delta, Number(el.min), Number(el.max)); renderSettingsSummary(); });

  function renderSettingsSummary(){
    const s=readSettings();
    $('#settingsSummary').textContent = `ğŸ•µï¸ ${s.spies} Â· ğŸ­ ${s.fakes} Â· âš–ï¸ ${s.laws} Â· â±ï¸ ${s.minutes}â€²`;
  }

  /* ====== Stats & History ====== */
  $('#statsCard').onclick=()=>{ renderHistory(); showView('view-history'); };
  $('#backFromHistory').onclick=()=>showView('view-landing');
  $('#clearHistory').onclick=()=> modal('Svuotare lo storico partite?',{title:'Conferma',actions:[
    {label:'Annulla',kind:'ghost'},
    {label:'Svuota',kind:'danger',onClick:()=>{ state.history=[]; LS.set('history',state.history); renderHistory(); renderStats(); }}
  ]});

  function renderStats(){
    const h=state.history; const n=h.length||0;
    const winCount=(k)=> h.filter(x=>x.winner===k).length;
    const pct=v=> n? Math.round(v*100/n):0;
    $('#s_games').textContent=n;
    $('#s_civ').textContent=pct(winCount('civ'))+'%';
    $('#s_spy').textContent=pct(winCount('spy'))+'%';
    $('#s_fake').textContent=pct(winCount('fake'))+'%';
    $('#s_law').textContent=pct(winCount('law'))+'%';
  }
  function renderHistory(){
    const box=$('#historyList'); const h=[...state.history].reverse();
    if(h.length===0){ box.innerHTML='<p class="muted">Ancora nessuna partita salvata.</p>'; return; }
    box.innerHTML = h.map(item=>{
      const ts=new Date(item.time).toLocaleString();
      const elim = item.eliminations.map(x=>`<li><span>${x.name}</span><span class="chip ${roleBadgeCls(x.role)}">${roleLabel(x.role)}</span></li>`).join('');
      const winners = item.winDetailHtml;
      return `<div class="card in" style="margin-bottom:10px">
        <p class="muted" style="margin:0">${ts} â€¢ Cat: <b>${item.category||'â€”'}</b> â€¢ Parola: <b>${item.secret||'â€”'}</b></p>
        <p style="margin:.5rem 0">Eliminazioni:</p>
        <ul class="list">${elim}</ul>
        <div style="margin-top:8px">${winners}</div>
      </div>`;
    }).join('');
  }

  /* ====== Game ====== */
  function startGame(){
    const s=readSettings();
    const cats=allCategories(); const words=(state.category && cats[state.category])?cats[state.category]:[];
    if(state.players.length<3) return modal('Devi avere almeno 3 giocatori.');
    if(s.spies<1) return modal('Serve almeno 1 Spia.');
    if(s.spies+s.fakes+s.laws>=state.players.length) return modal('I ruoli speciali totali devono essere minori dei giocatori.');
    if(!state.category||words.length===0) return modal('Seleziona una categoria con almeno una parola.');

    // setup
    LS.set('settings',s); LS.set('category',state.category);

    const secret = words[Math.floor(Math.random()*words.length)];
    const order=[...state.players]; for(let i=order.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [order[i],order[j]]=[order[j],order[i]]}

    // roles pool
    const roles=[]; for(let i=0;i<s.spies;i++) roles.push(Role.spy);
    for(let i=0;i<s.fakes;i++) roles.push(Role.fake);
    for(let i=0;i<s.laws;i++) roles.push(Role.law);
    while(roles.length<order.length) roles.push(Role.civ);
    for(let i=roles.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [roles[i],roles[j]]=[roles[j],roles[i]]}

    // build lawyer assignment: one lawyer per spy (round-robin)
    const spyIdxs=roles.map((r,i)=>r===Role.spy?i:-1).filter(i=>i>=0);
    const lawIdxs=roles.map((r,i)=>r===Role.law?i:-1).filter(i=>i>=0);
    const lawForSpy={}; spyIdxs.forEach((si,k)=>{const li = lawIdxs[k%lawIdxs.length]; if(li!=null && lawIdxs.length>0) lawForSpy[si]=li;});
    const spyNames = spyIdxs.map(i=>order[i]);

    state.game={
      order, roles, secret,
      lawForSpy, // mapping spyIndex -> lawyerIndex (if any)
      spiesKnow: s.optSpiesKnow,
      index:0, revealed:false,
      minutes:s.minutes, time:s.minutes*60, timer:null,
      voteRound:1, voteMaxRounds: spyIdxs.length || 1,
      eliminated:[], // array of {index,name,role}
      canVoteMask: order.map(()=>true), // chi puÃ² ancora votare
      optElimNoVote: s.optElimNoVote
    };

    showView('view-roles'); showNextRole();
  }

  $('#startGameMain').onclick=startGame;

  function roleRevealText(i){
    const g=state.game, role=g.roles[i];
    if(role===Role.civ) return `Sei un <span class="role-strong">Civile</span>! La parola Ã¨: <span class="role-word">${g.secret}</span>`;
    if(role===Role.fake) return `Sei la <span class="role-strong">Finta Spia</span>! Parola: <span class="role-word">${g.secret}</span>`;
    if(role===Role.law){
      // sa parola e NOME delle Spie vere
      const spies=g.roles.map((r,k)=> r===Role.spy ? g.order[k] : null).filter(Boolean);
      return `Sei l'<span class="role-strong">Avvocato</span>! La parola Ã¨ "<span class="role-word">${g.secret}</span>". Le Spie sono: <b>${spies.join(', ')||'â€”'}</b>.`;
    }
    if(role===Role.spy){
      const spiesOther = g.spiesKnow
        ? g.roles.map((r,k)=> (r===Role.spy && k!==i)? g.order[k] : null).filter(Boolean)
        : [];
      const know = spiesOther.length? `<br><small>Conosci anche: <b>${spiesOther.join(', ')}</b>.</small>` : '';
      return `Sei la <span class="role-strong">Spia</span>! <small>Gioca con il tuo avvocato, se te ne Ã¨ stato fornito uno dâ€™ufficio.</small>${know}`;
    }
  }

  function showNextRole(){
    const g=state.game; if(!g) return;
    if(g.index>=g.order.length){ showView('view-game'); startTimer(); setFirstQuestion(); return; }
    const name=g.order[g.index];
    $('#currentPlayer').textContent=name;
    const card=$('#roleCard'); card.classList.remove('revealed'); g.revealed=false;
    card.innerHTML = `<p class="muted">Tocca o premi Invio per vedere il tuo ruolo</p>`;
    $('#nextPlayer').disabled=true;

    function reveal(){
      if(g.revealed) return; g.revealed=true; card.classList.add('revealed');
      const role=g.roles[g.index];
      card.innerHTML = `
        <div style="text-align:center">
          <div class="badge ${roleBadgeCls(role)}" style="margin-bottom:8px">${roleLabel(role)}</div>
          <p style="font-size:1.12rem">${roleRevealText(g.index)}</p>
        </div>`;
      $('#nextPlayer').disabled=false;
    }
    card.onclick=reveal; card.onkeydown=e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); reveal(); } };
    card.onmousemove=e=>{const r=card.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width*2-1; const y=(e.clientY-r.top)/r.height*2-1; card.style.transform=`rotateX(${(-y*6).toFixed(2)}deg) rotateY(${(x*6).toFixed(2)}deg)`};
    card.onmouseleave=()=> card.style.transform='rotateX(0) rotateY(0)';
    $('#nextPlayer').onclick=()=>{ if(!g.revealed) return modal('Prima leggi il tuo ruolo.'); g.index++; showNextRole(); };
  }

  /* ====== Timer ====== */
  const fmt=s=>{const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`};
  function startTimer(){
    const g=state.game; if(!g) return;
    g.time=g.minutes*60; $('#timer').textContent=fmt(g.time);
    if(g.timer) {clearInterval(g.timer); g.timer=null;}
    g.timer=setInterval(()=>{ g.time=Math.max(0,g.time-1); $('#timer').textContent=fmt(g.time);
      if(g.time<=0){ clearInterval(g.timer); g.timer=null; try{$('#beep').currentTime=0; $('#beep').play().catch(()=>{});}catch{}; onTimeUp();}
    },1000);
  }
  function pauseTimer(){
    const g=state.game; if(!g) return;
    if(g.timer){ clearInterval(g.timer); g.timer=null; $('#pauseTimer').innerHTML='â–¶ï¸ Riprendi'; }
    else { startTimer(); $('#pauseTimer').innerHTML='â¸ï¸ Pausa'; }
  }
  $('#pauseTimer').onclick=pauseTimer;
  $('#endRound').onclick=()=>onTimeUp();

  function setFirstQuestion(){
    const g=state.game; const pick=g.order[(Math.random()*g.order.length)|0];
    $('#firstQuestionHint').innerHTML = `La prima domanda la fa: <b>${pick}</b><br><small>Iniziate a fare domande per scoprire chi Ã¨ la spia.</small>`;
  }

  function onTimeUp(){ modal('Tempo scaduto! Si va al voto.',{actions:[{label:'OK',kind:'ok',onClick:goVote}]}); }

  /* ====== VOTAZIONE multi-turno (numero turni = numero spie) ====== */
  function goVote(){
    const g=state.game;
    g.votes = {}; // reset per round
    $('#voteTitle').textContent = `ğŸ—³ï¸ Votate la spia ${g.voteRound}/${g.voteMaxRounds}`;
    const maxVoters = g.optElimNoVote ? g.canVoteMask.filter(Boolean).length : g.order.length;
    $('#voteSubHint').textContent = `Turno ${g.voteRound} di ${g.voteMaxRounds} â€¢ Votanti max: ${maxVoters}`;

    const ul=$('#voteList'); ul.innerHTML='';
    g.order.forEach((name,idx)=>{
      const alreadyEliminated = g.eliminated.some(x=>x.index===idx);
      const canVote = g.optElimNoVote ? g.canVoteMask[idx] : true;

      const li=document.createElement('li');
      li.innerHTML = `
        <span style="${alreadyEliminated?'text-decoration:line-through;opacity:.6':''}">${name}</span>
        <span class="row">
          <button class="btn ghost" data-dec>âˆ’</button>
          <span class="chip" data-count>0</span>
          <button class="btn secondary" data-inc ${alreadyEliminated?'disabled':''}>Vota</button>
        </span>`;
      const count=li.querySelector('[data-count]');
      g.votes[name]=0;

      li.querySelector('[data-inc]').onclick=()=>{ g.votes[name]++; count.textContent=g.votes[name]; };
      li.querySelector('[data-dec]').onclick=()=>{ g.votes[name]=Math.max(0,g.votes[name]-1); count.textContent=g.votes[name]; };

      // se eliminato, non puÃ² votare (opzionale)
      if(!canVote){ li.style.opacity=.6; li.title='Eliminato: non vota'; }

      ul.appendChild(li);
    });

    showView('view-vote');
  }

  // calcolo eliminazione del round (no paritÃ  ammessa)
  $('#seeRoundResult').onclick=()=>{
    const g=state.game;
    const entries=Object.entries(g.votes||{}).sort((a,b)=>b[1]-a[1]);
    if(!entries.length){ return modal('Nessun voto espresso. Assegnate almeno un voto.'); }
    const top=entries[0][1];
    const tied=entries.filter(e=>e[1]===top).map(e=>e[0]);
    if(tied.length!==1){
      return modal('âš ï¸ ParitÃ  rilevata. Dovete prendere una decisione prima di procedere!');
    }
    const name=tied[0];
    const idx=g.order.indexOf(name);
    const role=g.roles[idx];

    // registra eliminato
    g.eliminated.push({index:idx,name,role});
    if(g.optElimNoVote) g.canVoteMask[idx]=false;

    // mostra info round
    modal(`Eliminato <b>${name}</b> â€” era <b>${roleLabel(role)}</b>.`,{
      actions:[{label:'Continua',kind:'ok',onClick:afterElimination}]
    });
  };

  function afterElimination(){
    const g=state.game;
    // se abbiamo raggiunto il numero di turni richiesto -> esito finale
    if(g.voteRound>=g.voteMaxRounds){ finalizeGame(); return; }

    // aggiorna round e riparti (barrando gli eliminati)
    g.voteRound++;
    goVote();
  }

  /* ====== Regole di vittoria (come concordato) ======
     - Se viene votata una Finta Spia in QUALSIASI turno: vince quella Finta Spia, perdono tutti gli altri (anche le Spie vere).
     - Se (alla fine dei turni) Ã¨ rimasta almeno una Spia vera NON eliminata: vincono le Spie; vincono gli Avvocati assegnati alle Spie vincenti.
     - Se TUTTE le Spie vere sono state eliminate (e NON Ã¨ stata eliminata alcuna Finta Spia): vincono i Civili.
     - Se in un turno viene eliminato un Avvocato, ciÃ² contribuisce allâ€™esito solo in base alla vittoria della Spia a cui Ã¨ assegnato:
       * se la sua Spia vince (rimane viva), anche quellâ€™Avvocato â€œvinto insieme alla sua Spiaâ€.
     - Frasi finali: â€œX ha vintoâ€, â€œX ha vinto come finta spiaâ€, â€œi civili vinconoâ€, â€œX ha vinto insieme al suo avvocatoâ€¦â€
  */
  function finalizeGame(){
    const g=state.game;
    // comodi
    const spyIdxs = g.roles.map((r,i)=> r===Role.spy?i:-1).filter(i=>i>=0);
    const fakeIdxs= g.roles.map((r,i)=> r===Role.fake?i:-1).filter(i=>i>=0);

    const eliminatedIdxs = new Set(g.eliminated.map(x=>x.index));

    // 1) se Ã¨ stata eliminata una Finta Spia -> quella (o quelle) vince da sola
    const eliminatedFakes = g.eliminated.filter(x=>x.role===Role.fake);
    if(eliminatedFakes.length){
      const lines = eliminatedFakes.map(x=>`<p>ğŸ­ <b>${x.name}</b> ha vinto <i>come Finta Spia</i>.</p>`).join('');
      const html = lines + `<p class="muted">Tutti gli altri perdono (incluse le Spie vere e gli Avvocati).</p>`;
      endAndSave({winner:'fake', html});
      return;
    }

    // 2) Spie vive?
    const spiesAliveIdxs = spyIdxs.filter(i=>!eliminatedIdxs.has(i));
    if(spiesAliveIdxs.length){
      // vincono le Spie vive + i loro Avvocati (se assegnati)
      const aliveSpiesNames = spiesAliveIdxs.map(i=>g.order[i]);
      const lawyerWinners = spiesAliveIdxs.map(si=> g.lawForSpy[si]).filter(i=> Number.isInteger(i) && !eliminatedIdxs.has(i));
      const lawyerNames = [...new Set(lawyerWinners.map(i=>g.order[i]))];

      let html='';
      aliveSpiesNames.forEach(n=>{
        const si = g.order.indexOf(n);
        const li = g.lawForSpy[si];
        const lawName = Number.isInteger(li)? g.order[li] : null;
        if(lawName && !eliminatedIdxs.has(li)){
          html+=`<p>ğŸ•µï¸ <b>${n}</b> ha vinto <b>insieme al suo Avvocato</b> <b>${lawName}</b>.</p>`;
        }else{
          html+=`<p>ğŸ•µï¸ <b>${n}</b> ha vinto.</p>`;
        }
      });
      if(aliveSpiesNames.length>1) html+=`<p class="muted">Le Spie hanno prevalso.</p>`;
      endAndSave({winner:'spy', html});
      return;
    }

    // 3) Nessuna Spia viva e nessuna Finta Spia eliminata => vincono i Civili
    const html = `<p>ğŸ‘¤ <b>I Civili vincono</b>! Avete identificato correttamente tutte le Spie.</p>`;
    endAndSave({winner:'civ', html});
  }

  function endAndSave({winner, html}){
    showView('view-results');
    const g=state.game;
    // riepilogo voti/eliminazioni
    const elimHtml = g.eliminated.map(o=>`<li><span>${o.name}</span><span class="chip ${roleBadgeCls(o.role)}">${roleLabel(o.role)}</span></li>`).join('');
    const box = `
      <h3 class="section-title">Esito partita</h3>
      ${html}
      <h4 class="section-title" style="margin-top:12px">Eliminazioni</h4>
      <ul class="list">${elimHtml}</ul>`;
    $('#resultsBox').innerHTML = box;

    // pulsante "rivela tutti i ruoli" una sola volta
    let revealed=false;
    $('#revealAll').onclick=()=>{ if(revealed) return; revealed=true;
      const rows = g.order.map((p,i)=>`<li><span>${p}</span><span class="chip ${roleBadgeCls(g.roles[i])}">${roleLabel(g.roles[i])}</span></li>`).join('');
      $('#resultsBox').innerHTML += `<div style="margin-top:10px"><ul class="list">${rows}</ul></div>`;
      $('#revealAll').style.display='none';
    };

    // confetti lato civile vs spie vs fake
    confetti(winner==='civ'?'civ': winner==='fake'?'fake':'spy');

    // salva storico
    const winDetailHtml = html;
    state.history.push({
      time: Date.now(),
      winner,
      winDetailHtml,
      eliminations: g.eliminated,
      category: state.category,
      secret: g.secret
    });
    LS.set('history',state.history);
    renderStats();
  }

  function confetti(type){
    const cvs=document.getElementById('fxConfetti'); const ctx=cvs.getContext('2d');
    const W=cvs.width=innerWidth, H=cvs.height=innerHeight;
    const pal = type==='civ'?['#67e8f9','#60a5fa','#a78bfa','#ffffff'] : type==='fake'?['#f59e0b','#ffe08a','#ffd27d','#ffffff'] : ['#ef476f','#ff9aa5','#ffd1d6','#ffffff'];
    const parts=Array.from({length:110},()=>({x:Math.random()*W,y:-20,vx:(Math.random()-.5)*2,vy:2+Math.random()*2,size:4+Math.random()*6,rot:Math.random()*360,color:pal[(Math.random()*pal.length)|0],life:60+Math.random()*60}));
    let anim;
    function frame(){ ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{p.x+=p.vx; p.y+=p.vy; p.vy+=.02; p.rot+=3; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();});
      if(parts.some(p=>p.life>0 && p.y<H+20)) anim=requestAnimationFrame(frame); else cancelAnimationFrame(anim);
    } frame(); setTimeout(()=>ctx.clearRect(0,0,W,H),2500);
  }

  /* ====== Lang/Theme/Init ====== */
  function loadCustomForLang(lang){ state.custom = LS.get('custom_'+lang,{}); }
  function switchLang(lang){ state.lang=lang; LS.set('lang',lang); loadCustomForLang(lang); i18nRefresh(); }

  document.getElementById('lang').onchange=e=>switchLang(e.target.value);
  document.getElementById('themeBtn').onclick=cycleTheme;
  document.getElementById('howToBtn').onclick=()=>showRules();

  function showRules(){
    const html=`
    <h3>ğŸ² Scopo del gioco</h3>
    <p>I <b>Civili</b> devono <b>eliminare la/ le Spie vere</b> entro i turni di voto disponibili.<br>
    La <b>Spia</b> vince se <b>non viene votata</b> (basta che ne sopravviva almeno una).</p>

    <h3>ğŸ§© Ruoli</h3>
    <ul>
      <li>ğŸ•µï¸ <b>Spia</b>: non conosce la parola. <u>Vince se non viene eliminata</u>. In reveal: â€œgioca con il tuo avvocato, se te ne Ã¨ stato fornito uno dâ€™ufficioâ€. Le spie possono <b>conoscersi</b> tra loro (opzione), <b>escluse</b> le Finte Spie.</li>
      <li>ğŸ­ <b>Finta Spia</b>: <i>conosce</i> la parola. <u>Vince solo se viene eliminata</u> (passando per Spia). Se succede, <b>perdono tutti gli altri</b>, comprese le Spie.</li>
      <li>âš–ï¸ <b>Avvocato</b>: conosce parola e Spie vere. Ãˆ <i>assegnato</i> a una Spia; se quella Spia <b>vince</b>, <b>vince anche il suo Avvocato</b> (anche se durante i turni Ã¨ stato eliminato).</li>
      <li>ğŸ‘¤ <b>Civile</b>: conosce la parola e prova a smascherare le Spie.</li>
    </ul>

    <h3>â³ Round</h3>
    <ol>
      <li>Assegnazione ruoli (reveal uno alla volta).</li>
      <li>Discussione a tempo.</li>
      <li><b>Voto a turni</b>: numero turni = numero di Spie. A ogni turno si elimina una persona. Gli eliminati possono <b>non votare piÃ¹</b> se attivi lâ€™opzione.</li>
      <li>Esito finale secondo le regole sopra.</li>
    </ol>

    <h3>âš ï¸ ParitÃ </h3>
    <p>Le votazioni <b>non possono finire in paritÃ </b>: se succede, il gioco vi chiede di decidere prima di procedere.</p>`;
    modal(html,{title:'Regole',actions:[{label:'OK',kind:'ok'}]});
  }
  $('#helpBtn').onclick=showRules;

  // Init
  (function init(){
    applyTheme();
    $('#themeBtn').textContent=state.theme==='auto'?'ğŸŒ“':state.theme==='light'?'â˜€ï¸':'ğŸŒ™';
    loadCustomForLang(state.lang);
    i18nRefresh(); writeSettings(state.settings);
    // chiude di default i collapsible
    $$('[data-collapsible]').forEach(c=>c.classList.remove('open'));
    document.getElementById('goStart').onclick=()=>showView('view-home');
    document.getElementById('goHow').onclick=showRules;
  })();
  </script>
</body>
</html>
